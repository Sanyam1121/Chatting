<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Firebase Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@4.6.2/dist/index.min.js"></script>
  <script type="module">
    // Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      onSnapshot,
      query,
      orderBy,
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import {
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDuGHDotdc-EZRxyyJLrWXyLsi2dLhSHm4",
      authDomain: "chatting-fd641.firebaseapp.com",
      projectId: "chatting-fd641",
      storageBucket: "chatting-fd641.appspot.com",
      messagingSenderId: "535384451291",
      appId: "1:535384451291:web:828f60686d81be018b44fe",
      measurementId: "G-RKS4CFZPJ4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    let username = "";
    let selectedImage = null;

    function login() {
      const nameInput = document.getElementById("usernameInput");
      username = nameInput.value.trim();
      if (!username) return alert("Enter a username");
      document.getElementById("loginPage").classList.add("hidden");
      document.getElementById("chatPage").classList.remove("hidden");
      document.getElementById("currentUserLabel").textContent = `Logged in as: ${username}`;
      listenToMessages();
    }

    async function sendMessage() {
      const text = document.getElementById("messageInput").value.trim();
      if (!text && !selectedImage) return;

      let imageUrl = null;

      if (selectedImage) {
        const storageRef = ref(storage, 'images/' + Date.now() + '-' + selectedImage.name);
        await uploadBytes(storageRef, selectedImage);
        imageUrl = await getDownloadURL(storageRef);
        selectedImage = null;
      }

      await addDoc(collection(db, "messages"), {
        username,
        text: text || null,
        imageUrl: imageUrl || null,
        timestamp: new Date()
      });

      document.getElementById("messageInput").value = "";
      document.getElementById("imageInput").value = "";
    }

    function listenToMessages() {
      const messagesRef = collection(db, "messages");
      const q = query(messagesRef, orderBy("timestamp", "asc"));
      onSnapshot(q, snapshot => {
        const messages = document.getElementById("messages");
        messages.innerHTML = "";
        snapshot.forEach(doc => {
          const msg = doc.data();
          const div = document.createElement("div");
          div.className = "p-2 rounded-lg max-w-[70%] mb-2 " + (msg.username === username ? "bg-blue-500 text-white self-end" : "bg-gray-200 text-black self-start dark:bg-gray-700 dark:text-white");
          div.innerHTML = `
            <div class="text-xs mb-1 opacity-70">${msg.username}</div>
            ${msg.text ? `<div>${msg.text}</div>` : ""}
            ${msg.imageUrl ? `<img src="${msg.imageUrl}" class="mt-2 rounded shadow max-w-[200px]"/>` : ""}
          `;
          messages.appendChild(div);
        });
        messages.scrollTop = messages.scrollHeight;
      });
    }

    function previewImage(event) {
      selectedImage = event.target.files[0];
    }

    function toggleDarkMode() {
      document.body.classList.toggle("dark");
    }

    window.login = login;
    window.sendMessage = sendMessage;
    window.previewImage = previewImage;
    window.toggleDarkMode = toggleDarkMode;

    window.onload = () => {
      const picker = new EmojiButton();
      const trigger = document.querySelector('#emojiBtn');
      picker.on('emoji', emoji => {
        document.getElementById('messageInput').value += emoji;
      });
      trigger.addEventListener('click', () => picker.togglePicker(trigger));
    }
  </script>

  <style>
    body.dark { background-color: #1a202c; color: white; }
    .dark input, .dark textarea { color: black; }
  </style>
</head>

<body class="min-h-screen bg-gray-100 dark:bg-gray-900 text-black dark:text-white flex flex-col items-center p-4">

  <button onclick="toggleDarkMode()" class="absolute top-4 right-4 px-3 py-1 bg-gray-700 text-white rounded text-sm">Toggle Dark Mode</button>

  <!-- Login -->
  <div id="loginPage" class="w-full max-w-sm bg-white dark:bg-gray-800 rounded-lg shadow p-6">
    <h1 class="text-xl font-bold mb-4">Enter Username</h1>
    <input id="usernameInput" type="text" placeholder="Your username" class="w-full border rounded p-2 mb-4 text-black" />
    <button onclick="login()" class="bg-blue-500 text-white px-4 py-2 rounded w-full">Join Chat</button>
  </div>

  <!-- Chat UI -->
  <div id="chatPage" class="hidden w-full max-w-2xl flex flex-col bg-white dark:bg-gray-800 rounded shadow-lg h-[85vh] mt-6">
    <div class="p-4 border-b dark:border-gray-700 font-bold text-lg flex justify-between">
      Group Chat
      <span class="text-xs italic" id="currentUserLabel"></span>
    </div>
    <div id="messages" class="flex-1 overflow-y-auto p-4 flex flex-col space-y-2"></div>
    <div class="p-3 flex items-center gap-2 border-t dark:border-gray-700">
      <button id="emojiBtn" class="text-2xl">ðŸ˜Š</button>
      <input id="messageInput" type="text" placeholder="Type a message" class="flex-1 p-2 border rounded text-sm text-black" />
      <input type="file" id="imageInput" accept="image/*" onchange="previewImage(event)" class="hidden" />
      <button onclick="document.getElementById('imageInput').click()" class="bg-gray-300 dark:bg-gray-700 px-2 py-1 rounded text-sm">ðŸ“·</button>
      <button onclick="sendMessage()" class="bg-blue-600 text-white px-4 py-1 rounded">Send</button>
    </div>
  </div>
</body>
</html>
