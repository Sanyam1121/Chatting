<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chat App - ONlyforHer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@4.6.2/dist/index.min.js"></script>
  </head>
  <body class="min-h-screen bg-gray-100 dark:bg-gray-900 text-black dark:text-white flex flex-col items-center p-4">
    <div id="auth-section" class="w-full max-w-sm bg-white dark:bg-gray-800 rounded-lg shadow p-6">
      <h1 class="text-xl font-bold mb-4">Chat Login / Sign Up</h1>
      <input id="username" type="text" placeholder="Username (for Sign Up)" class="w-full border rounded p-2 mb-2 text-black" />
      <input id="email" type="email" placeholder="Email" class="w-full border rounded p-2 mb-2 text-black" />
      <input id="password" type="password" placeholder="Password" class="w-full border rounded p-2 mb-2 text-black" />
      <button onclick="login()" class="bg-blue-500 text-white px-4 py-2 rounded w-full mb-2">Login</button>
      <button onclick="signup()" class="bg-green-500 text-white px-4 py-2 rounded w-full mb-2">Sign Up</button>
      <p class="text-xs text-gray-500">* Enter username only when signing up</p>
    </div>

    <div id="chat-ui" class="hidden w-full max-w-2xl flex flex-col bg-white dark:bg-gray-800 rounded shadow-lg h-[85vh] mt-6">
      <div id="groupsPage" class="flex flex-col h-full">
        <div class="font-bold text-lg mb-2 flex justify-between items-center px-4 py-2 border-b dark:border-gray-700">
          Groups
          <span id="currentUserLabel" class="text-xs italic"></span>
          <button id="logoutBtn" class="bg-red-600 text-white px-3 py-1 rounded ml-4">Logout</button>
        </div>
        <div id="groupsList" class="flex-1 overflow-y-auto p-4"></div>
        <div class="flex gap-2 p-4 border-t dark:border-gray-700">
          <input id="newGroupName" type="text" placeholder="New group name" class="flex-1 border rounded p-2 text-black" />
          <button onclick="createGroup()" class="bg-green-600 text-white px-4 rounded">Create</button>
        </div>
      </div>

      <div id="chatPage" class="hidden flex flex-col h-full">
        <div class="flex items-center justify-between p-4 border-b dark:border-gray-700">
          <button onclick="backToGroups()" class="text-blue-600 dark:text-blue-400">‚Üê Back to groups</button>
          <h2 id="groupTitle" class="font-bold text-lg"></h2>
          <div></div>
        </div>
        <div id="messages" class="flex-1 overflow-y-auto p-4 flex flex-col gap-1"></div>
        <div class="p-4 border-t dark:border-gray-700 flex items-center gap-2">
          <button id="emojiBtn" class="text-xl">üòä</button>
          <input id="messageInput" type="text" placeholder="Type a message" class="flex-1 border rounded p-2 text-black" autocomplete="off" />
          <input type="file" id="imageInput" accept="image/*" onchange="previewImage(event)" class="hidden" />
          <button onclick="document.getElementById('imageInput').click()" class="bg-gray-200 dark:bg-gray-700 rounded px-3 py-2">üì∑</button>
          <button onclick="sendMessage()" class="bg-blue-600 text-white px-4 py-2 rounded">Send</button>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import {
        getAuth,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        onAuthStateChanged,
        signOut
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import {
        getFirestore,
        collection,
        addDoc,
        onSnapshot,
        query,
        orderBy,
        doc,
        getDoc,
        getDocs,
        deleteDoc,
        setDoc,
        serverTimestamp
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
      import {
        getStorage,
        ref,
        uploadBytes,
        getDownloadURL
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDuGHDotdc-EZRxyyJLrWXyLsi2dLhSHm4",
        authDomain: "chatting-fd641.firebaseapp.com",
        projectId: "chatting-fd641",
        storageBucket: "chatting-fd641.appspot.com",
        messagingSenderId: "535384451291",
        appId: "1:535384451291:web:828f60686d81be018b44fe",
        measurementId: "G-RKS4CFZPJ4"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const storage = getStorage(app);

      let currentGroupId = null;
      let selectedImage = null;
      let currentUsername = null;

      const usernameEl = document.getElementById("username");
      const emailEl = document.getElementById("email");
      const passEl = document.getElementById("password");

      async function signup() {
        const username = usernameEl.value.trim();
        const email = emailEl.value.trim();
        const password = passEl.value;

        if (!username) return alert("Please enter a username for sign up.");
        if (!email) return alert("Please enter an email.");
        if (!password) return alert("Please enter a password.");

        try {
          const userCredential = await createUserWithEmailAndPassword(auth, email, password);
          const user = userCredential.user;

          // Save username to Firestore under 'users' collection, document ID = user.uid
          await setDoc(doc(db, "users", user.uid), { username });

          currentUsername = username;
          usernameEl.value = "";
          emailEl.value = "";
          passEl.value = "";
        } catch (e) {
          alert("Signup failed: " + e.message);
        }
      }

      async function login() {
        const email = emailEl.value.trim();
        const password = passEl.value;
        if (!email) return alert("Please enter your email.");
        if (!password) return alert("Please enter your password.");

        try {
          const userCredential = await signInWithEmailAndPassword(auth, email, password);
          const user = userCredential.user;

          // Fetch username from Firestore
          const userDoc = await getDoc(doc(db, "users", user.uid));
          if (userDoc.exists()) {
            currentUsername = userDoc.data().username || user.email;
          } else {
            currentUsername = user.email;
          }

          usernameEl.value = "";
          emailEl.value = "";
          passEl.value = "";
        } catch (e) {
          alert("Login failed: " + e.message);
        }
      }

      // Expose login/signup to global scope for inline onclick
      window.login = login;
      window.signup = signup;

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          // Load username on auth state change
          const userDoc = await getDoc(doc(db, "users", user.uid));
          currentUsername = userDoc.exists() ? userDoc.data().username : user.email;

          document.getElementById("auth-section").style.display = "none";
          document.getElementById("chat-ui").classList.remove("hidden");
          document.getElementById("currentUserLabel").textContent = `Logged in as: ${currentUsername}`;
          loadGroups();
        } else {
          currentGroupId = null;
          currentUsername = null;
          document.getElementById("auth-section").style.display = "block";
          document.getElementById("chat-ui").classList.add("hidden");
        }
      });

      async function logout() {
        await signOut(auth);
      }
      window.logout = logout;
      document.getElementById("logoutBtn").addEventListener("click", logout);

      function loadGroups() {
        const groupsList = document.getElementById("groupsList");
        groupsList.innerHTML = "Loading groups...";
        const groupsRef = collection(db, "groups");
        onSnapshot(groupsRef, snapshot => {
          groupsList.innerHTML = "";
          if (snapshot.empty) {
            groupsList.innerHTML = "<p class='text-gray-500'>No groups yet. Create one!</p>";
            return;
          }
          snapshot.forEach(docSnap => {
            const group = docSnap.data();
            const container = document.createElement("div");
            container.className = "p-3 border rounded mb-2 flex justify-between items-center hover:bg-blue-100 dark:hover:bg-gray-700";

            const nameDiv = document.createElement("div");
            nameDiv.textContent = group.name;
            nameDiv.className = "cursor-pointer flex-1";
            nameDiv.onclick = () => enterGroup(docSnap.id, group.name);

            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "‚ùå";
            deleteBtn.className = "ml-2 text-red-600 hover:text-red-800 text-sm";
            deleteBtn.onclick = e => {
              e.stopPropagation();
              if (confirm(`Delete group "${group.name}"?`)) {
                deleteGroup(docSnap.id);
              }
            };

            container.appendChild(nameDiv);
            container.appendChild(deleteBtn);
            groupsList.appendChild(container);
          });
        });
      }

      async function deleteGroup(groupId) {
        const messagesRef = collection(db, "groups", groupId, "messages");
        const messagesSnap = await getDocs(messagesRef);
        const deletePromises = messagesSnap.docs.map(doc => deleteDoc(doc.ref));
        await Promise.all(deletePromises);
        await deleteDoc(doc(db, "groups", groupId));
        alert("Group deleted successfully.");
      }

      window.createGroup = async () => {
        const groupNameInput = document.getElementById("newGroupName");
        const name = groupNameInput.value.trim();
        if (!name) return alert("Enter a group name");
        await addDoc(collection(db, "groups"), {
          name,
          createdAt: serverTimestamp()
        });
        groupNameInput.value = "";
      };

      function enterGroup(groupId, groupName) {
        currentGroupId = groupId;
        document.getElementById("groupTitle").textContent = groupName;
        document.getElementById("groupsPage").classList.add("hidden");
        document.getElementById("chatPage").classList.remove("hidden");
        listenToMessages(groupId);
      }

      window.backToGroups = () => {
        currentGroupId = null;
        document.getElementById("chatPage").classList.add("hidden");
        document.getElementById("groupsPage").classList.remove("hidden");
      };

      window.sendMessage = async () => {
        const user = auth.currentUser;
        if (!currentGroupId || !user) return alert("No group or user selected");
        const text = document.getElementById("messageInput").value.trim();
        if (!text && !selectedImage) return alert("Type a message or select an image");

        let imageUrl = null;
        if (selectedImage) {
          const storageRef = ref(storage, `images/${Date.now()}_${selectedImage.name}`);
          await uploadBytes(storageRef, selectedImage);
          imageUrl = await getDownloadURL(storageRef);
          selectedImage = null;
          document.getElementById("imageInput").value = "";
        }

        await addDoc(collection(db, "groups", currentGroupId, "messages"), {
          text: text || "",
          imageUrl: imageUrl,
          createdAt: serverTimestamp(),
          uid: user.uid,
          username: currentUsername || user.email
        });

        document.getElementById("messageInput").value = "";
      };

      function previewImage(event) {
        selectedImage = event.target.files[0];
      }

      function listenToMessages(groupId) {
        const messagesDiv = document.getElementById("messages");
        messagesDiv.innerHTML = "Loading messages...";
        const messagesRef = collection(db, "groups", groupId, "messages");
        const q = query(messagesRef, orderBy("createdAt", "asc"));
        onSnapshot(q, (snapshot) => {
          messagesDiv.innerHTML = "";
          snapshot.forEach(docSnap => {
            const msg = docSnap.data();
            const messageEl = document.createElement("div");
            messageEl.className = "border rounded p-2";

            const usernameEl = document.createElement("div");
            usernameEl.textContent = msg.username || "Unknown";
            usernameEl.className = "font-semibold text-blue-600";

            const textEl = document.createElement("div");
            textEl.textContent = msg.text;

            messageEl.appendChild(usernameEl);
            if (msg.imageUrl) {
              const imgEl = document.createElement("img");
              imgEl.src = msg.imageUrl;
              imgEl.alt = "sent image";
              imgEl.className = "max-w-xs rounded my-2";
              messageEl.appendChild(imgEl);
            }
            messageEl.appendChild(textEl);
            messagesDiv.appendChild(messageEl);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
          });
          if (snapshot.empty) {
            messagesDiv.innerHTML = "<p class='text-gray-500 italic'>No messages yet. Say hi!</p>";
          }
        });
      }

      // Emoji picker integration
      const emojiPicker = new EmojiButton({
        position: 'top-end',
        theme: 'auto',
        autoHide: true,
      });
      const emojiBtn = document.getElementById("emojiBtn");
      const messageInput = document.getElementById("messageInput");

      emojiBtn.addEventListener("click", () => {
        emojiPicker.togglePicker(emojiBtn);
      });

      emojiPicker.on('emoji', emoji => {
        messageInput.value += emoji;
        messageInput.focus();
      });
    </script>
  </body>
</html>
