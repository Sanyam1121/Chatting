<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Group Chat with Google Login</title>
  <script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getAuth,
      signInWithPopup,
      GoogleAuthProvider,
      signOut,
      onAuthStateChanged,
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      query,
      where,
      onSnapshot,
      serverTimestamp,
      orderBy,
      doc,
      setDoc,
      getDoc,
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
    import {
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL,
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

    // Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDuGHDotdc-EZRxyyJLrWXyLsi2dLhSHm4",
      authDomain: "chatting-fd641.firebaseapp.com",
      projectId: "chatting-fd641",
      storageBucket: "chatting-fd641.appspot.com",
      messagingSenderId: "535384451291",
      appId: "1:535384451291:web:828f60686d81be018b44fe",
      measurementId: "G-RKS4CFZPJ4"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // UI elements
    const loginPage = document.getElementById("loginPage");
    const groupsPage = document.getElementById("groupsPage");
    const chatPage = document.getElementById("chatPage");
    const userLabel = document.getElementById("userLabel");
    const groupsList = document.getElementById("groupsList");
    const groupTitle = document.getElementById("groupTitle");
    const messagesDiv = document.getElementById("messages");
    const messageInput = document.getElementById("messageInput");
    const imageInput = document.getElementById("imageInput");

    let currentGroupId = null;
    let unsubscribeMessages = null;

    // Show only one page at a time
    function showPage(page) {
      loginPage.classList.add("hidden");
      groupsPage.classList.add("hidden");
      chatPage.classList.add("hidden");
      page.classList.remove("hidden");
    }

    // Google login handler
    async function loginWithGoogle() {
      const provider = new GoogleAuthProvider();
      try {
        await signInWithPopup(auth, provider);
      } catch (error) {
        alert("Login failed: " + error.message);
      }
    }

    // Logout
    async function logout() {
      if (unsubscribeMessages) unsubscribeMessages();
      await signOut(auth);
    }

    // Load groups list
    function loadGroups() {
      const groupsRef = collection(db, "groups");
      onSnapshot(groupsRef, (snapshot) => {
        groupsList.innerHTML = "";
        snapshot.forEach((docSnap) => {
          const group = docSnap.data();
          const groupId = docSnap.id;
          const div = document.createElement("div");
          div.textContent = group.name;
          div.className = "cursor-pointer p-2 border rounded hover:bg-gray-200 dark:hover:bg-gray-700";
          div.onclick = () => openGroupChat(groupId, group.name);
          groupsList.appendChild(div);
        });
      });
    }

    // Create group
    async function createGroup() {
      const groupNameInput = document.getElementById("newGroupName");
      const name = groupNameInput.value.trim();
      if (!name) return alert("Enter group name");
      try {
        await addDoc(collection(db, "groups"), {
          name,
          createdAt: serverTimestamp(),
        });
        groupNameInput.value = "";
      } catch (e) {
        alert("Failed to create group: " + e.message);
      }
    }

    // Open group chat
    function openGroupChat(groupId, groupName) {
      currentGroupId = groupId;
      groupTitle.textContent = groupName;
      showPage(chatPage);
      messagesDiv.innerHTML = "";
      if (unsubscribeMessages) unsubscribeMessages();
      const messagesRef = collection(db, "groups", groupId, "messages");
      const q = query(messagesRef, orderBy("createdAt"));
      unsubscribeMessages = onSnapshot(q, (snapshot) => {
        messagesDiv.innerHTML = "";
        snapshot.forEach((docSnap) => {
          const msg = docSnap.data();
          const div = document.createElement("div");
          div.className = msg.uid === auth.currentUser.uid ? "self-message" : "other-message";
          if(msg.text) {
            div.textContent = msg.text;
          }
          if(msg.imageUrl) {
            const img = document.createElement("img");
            img.src = msg.imageUrl;
            img.style.maxWidth = "200px";
            img.style.display = "block";
            div.appendChild(img);
          }
          messagesDiv.appendChild(div);
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });
    }

    // Send message
    async function sendMessage() {
      if (!currentGroupId) return alert("Select a group first");
      const text = messageInput.value.trim();
      const file = imageInput.files[0];

      if (!text && !file) return;

      let imageUrl = null;
      if (file) {
        // Upload image
        const storageRef = ref(storage, `images/${currentGroupId}/${Date.now()}_${file.name}`);
        await uploadBytes(storageRef, file);
        imageUrl = await getDownloadURL(storageRef);
      }

      try {
        await addDoc(collection(db, "groups", currentGroupId, "messages"), {
          uid: auth.currentUser.uid,
          displayName: auth.currentUser.displayName,
          text: text || null,
          imageUrl,
          createdAt: serverTimestamp(),
        });
        messageInput.value = "";
        imageInput.value = "";
      } catch (e) {
        alert("Failed to send message: " + e.message);
      }
    }

    // On auth state changed
    onAuthStateChanged(auth, (user) => {
      if (user) {
        userLabel.textContent = `Hello, ${user.displayName}`;
        showPage(groupsPage);
        loadGroups();
      } else {
        userLabel.textContent = "";
        showPage(loginPage);
        if (unsubscribeMessages) {
          unsubscribeMessages();
          unsubscribeMessages = null;
        }
      }
    });

    // Expose functions globally for buttons
    window.loginWithGoogle = loginWithGoogle;
    window.logout = logout;
    window.createGroup = createGroup;
    window.sendMessage = sendMessage;
  </script>
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 1rem;
      background-color: #121212;
      color: white;
    }
    .hidden { display: none; }
    #loginPage, #groupsPage, #chatPage {
      max-width: 480px;
      margin: auto;
      background: #1e1e1e;
      padding: 1rem;
      border-radius: 8px;
    }
    button {
      cursor: pointer;
      background: #4285f4;
      border: none;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 4px;
    }
    input[type=text], input[type=file] {
      width: 100%;
      padding: 0.5rem;
      border-radius: 4px;
      border: none;
      margin-bottom: 0.5rem;
    }
    .self-message {
      background-color: #3a86ff;
      color: white;
      align-self: flex-end;
      padding: 6px 10px;
      border-radius: 10px;
      margin: 3px 0;
      max-width: 80%;
      word-wrap: break-word;
    }
    .other-message {
      background-color: #888;
      color: white;
      align-self: flex-start;
      padding: 6px 10px;
      border-radius: 10px;
      margin: 3px 0;
      max-width: 80%;
      word-wrap: break-word;
    }
    #messages {
      display: flex;
      flex-direction: column;
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #444;
      padding: 1rem;
      margin-bottom: 1rem;
      background: #222;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <!-- Login Page -->
  <div id="loginPage">
    <h2>Login with Google</h2>
    <button onclick="loginWithGoogle()">Sign in with Google</button>
  </div>

  <!-- Groups Page -->
  <div id="groupsPage" class="hidden">
    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
      <span id="userLabel"></span>
      <button onclick="logout()">Logout</button>
    </div>
    <h2>Groups</h2>
    <div style="margin-bottom: 1rem;">
      <input type="text" id="newGroupName" placeholder="New group name" />
      <button onclick="createGroup()">Create</button>
    </div>
    <div id="groupsList"></div>
  </div>

  <!-- Chat Page -->
  <div id="chatPage" class="hidden" style="display:flex; flex-direction: column;">
    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
      <button onclick="showPage(groupsPage)">‚Üê Back to Groups</button>
      <h3 id="groupTitle"></h3>
      <div></div>
    </div>
    <div id="messages"></div>
    <input type="text" id="messageInput" placeholder="Type a message..." />
    <input type="file" id="imageInput" accept="image/*" />
    <button onclick="sendMessage()">Send</button>
  </div>
</body>
</html>
