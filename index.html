<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat App</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@4.6.2/dist/index.min.js"></script>
  <style>
    .message { padding: 8px 12px; border-radius: 18px; margin: 4px 0; max-width: 70%; word-wrap: break-word; }
    .me { background-color: #4f46e5; color: white; align-self: flex-end; }
    .other { background-color: #e5e7eb; color: black; align-self: flex-start; }
    .dark .me { background-color: #2563eb; }
    .dark .other { background-color: #374151; color: white; }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-black dark:text-white min-h-screen flex flex-col items-center p-4 transition-colors duration-300">

  <!-- Dark Mode Toggle -->
  <button onclick="toggleDarkMode()" class="absolute top-4 right-4 px-3 py-1 bg-gray-700 text-white rounded text-sm">Toggle Dark Mode</button>

  <!-- Login -->
  <div id="loginPage" class="w-full max-w-sm bg-white dark:bg-gray-800 rounded-lg shadow p-6">
    <h1 class="text-xl font-bold mb-4">Enter Username</h1>
    <input id="usernameInput" type="text" placeholder="Your username" class="w-full border rounded p-2 mb-4 text-black" />
    <button onclick="login()" class="bg-blue-500 text-white px-4 py-2 rounded w-full">Join Chat</button>
  </div>

  <!-- Chat App -->
  <div id="chatPage" class="hidden w-full max-w-6xl bg-white dark:bg-gray-800 rounded-lg shadow flex flex-col md:flex-row h-[85vh] mt-6 overflow-hidden">

    <!-- Sidebar -->
    <div class="w-full md:w-1/3 border-r dark:border-gray-700 flex flex-col">
      <div class="p-4 font-bold text-lg border-b dark:border-gray-700">Chats</div>
      <div class="p-2 flex-1 overflow-y-auto space-y-2" id="chatList"></div>
      <div class="p-2 border-t dark:border-gray-700">
        <input id="groupNameInput" placeholder="New group name" class="w-full border rounded p-1 text-sm text-black" />
        <button onclick="createGroup()" class="w-full mt-2 text-sm bg-green-500 text-white py-1 rounded">Create Group</button>
      </div>
    </div>

    <!-- Chat Area -->
    <div class="w-full md:w-2/3 flex flex-col">
      <div class="p-4 border-b dark:border-gray-700 font-bold flex justify-between items-center">
        <span id="chatTitle">Select a chat</span>
        <span class="text-xs italic hidden md:inline" id="currentUserLabel"></span>
      </div>
      <div id="messages" class="flex-1 p-4 overflow-y-auto flex flex-col space-y-2"></div>
      <div class="flex flex-wrap items-center border-t dark:border-gray-700 p-2 gap-2">
        <button id="emojiBtn" class="text-2xl">ðŸ˜Š</button>
        <input id="messageInput" placeholder="Type a message..." class="flex-1 min-w-[150px] border rounded p-2 text-sm text-black" />
        <input type="file" id="imageInput" accept="image/*" class="hidden" onchange="previewImage(event)">
        <button onclick="document.getElementById('imageInput').click()" class="bg-gray-300 dark:bg-gray-700 text-sm px-2 py-1 rounded">ðŸ“·</button>
        <button onclick="sendMessage()" class="bg-blue-600 text-white px-4 py-1 rounded">Send</button>
      </div>
    </div>
  </div>

  <script>
    let username = "";
    let currentChat = "";
    const users = new Set();
    const groups = {};
    const chats = {};
    let selectedImage = null;

    function login() {
      const input = document.getElementById('usernameInput');
      const name = input.value.trim();
      if (!name) return alert("Enter a username!");
      username = name;
      users.add(username);
      document.getElementById('loginPage').classList.add('hidden');
      document.getElementById('chatPage').classList.remove('hidden');
      document.getElementById('currentUserLabel').innerText = `Logged in as: ${username}`;
      updateChatList();
    }

    function updateChatList() {
      const chatList = document.getElementById('chatList');
      chatList.innerHTML = "";
      [...users].filter(u => u !== username).forEach(u => {
        const btn = document.createElement('button');
        btn.innerText = u;
        btn.className = "block w-full text-left p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded";
        btn.onclick = () => openChat(u);
        chatList.appendChild(btn);
      });

      Object.keys(groups).forEach(group => {
        const btn = document.createElement('button');
        btn.innerText = "Group: " + group;
        btn.className = "block w-full text-left p-2 hover:bg-green-100 dark:hover:bg-green-800 rounded text-green-800 dark:text-green-300";
        btn.onclick = () => openChat(group, true);
        chatList.appendChild(btn);
      });
    }

    function openChat(name, isGroup = false) {
      currentChat = name;
      document.getElementById('chatTitle').innerText = isGroup ? `Group: ${name}` : name;
      if (!chats[currentChat]) chats[currentChat] = [];
      renderMessages();
    }

    function createGroup() {
      const name = document.getElementById('groupNameInput').value.trim();
      if (!name) return alert("Enter group name");
      if (groups[name]) return alert("Group already exists!");
      groups[name] = new Set([username]);
      chats[name] = [];
      updateChatList();
      document.getElementById('groupNameInput').value = "";
    }

    function sendMessage() {
      const input = document.getElementById('messageInput');
      const msg = input.value.trim();
      if (!msg && !selectedImage) return;
      if (!currentChat) return;

      if (!chats[currentChat]) chats[currentChat] = [];
      chats[currentChat].push({
        sender: username,
        text: msg || null,
        image: selectedImage || null,
      });

      input.value = "";
      selectedImage = null;
      renderMessages();
    }

    function previewImage(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        selectedImage = reader.result;
      };
      reader.readAsDataURL(file);
    }

    function renderMessages() {
      const msgBox = document.getElementById('messages');
      msgBox.innerHTML = "";
      (chats[currentChat] || []).forEach(m => {
        const div = document.createElement('div');
        div.className = "message " + (m.sender === username ? "me self-end" : "other self-start");
        div.innerHTML = `<div class="text-xs opacity-70 mb-1">${m.sender}</div>`;
        if (m.text) div.innerHTML += `<div>${m.text}</div>`;
        if (m.image) div.innerHTML += `<img src="${m.image}" class="mt-2 max-w-[200px] rounded shadow" />`;
        msgBox.appendChild(div);
      });
      msgBox.scrollTop = msgBox.scrollHeight;
    }

    // Emoji Picker
    const picker = new EmojiButton();
    const trigger = document.querySelector('#emojiBtn');
    picker.on('emoji', emoji => {
      document.getElementById('messageInput').value += emoji;
    });
    trigger.addEventListener('click', () => picker.togglePicker(trigger));

    function toggleDarkMode() {
      document.body.classList.toggle('dark');
    }
  </script>
</body>
</html>
