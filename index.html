<!DOCTYPE html>
<html lang="en" class="dark">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WhatsApp Style Chat</title>

<!-- Tailwind CSS CDN -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Emoji Button -->
<script src="https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@4.6.2/dist/index.min.js"></script>

<style>
  /* WhatsApp style custom tweaks */
  body {
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: #ece5dd;
    height: 100vh;
    margin: 0;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .app-container {
    width: 100vw;
    height: 100vh;
    max-width: 1100px;
    max-height: 700px;
    background: white;
    display: flex;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border-radius: 8px;
    overflow: hidden;
  }
  /* Sidebar (groups list) */
  #groupsPage {
    width: 320px;
    background: #ffffff;
    border-right: 1px solid #ddd;
    display: flex;
    flex-direction: column;
  }
  #groupsPage header {
    font-weight: 600;
    font-size: 1.2rem;
    padding: 15px 20px;
    border-bottom: 1px solid #ddd;
    background: #f6f6f6;
  }
  #groupsList {
    flex-grow: 1;
    overflow-y: auto;
    padding: 10px 15px;
  }
  #groupsList div {
    padding: 12px 15px;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: background-color 0.15s ease;
  }
  #groupsList div:hover {
    background: #f2f2f2;
  }
  #groupsList div.selected {
    background: #dcf8c6;
  }
  #groupsList button {
    background: transparent;
    border: none;
    font-size: 1rem;
    cursor: pointer;
  }
  #newGroupForm {
    padding: 10px 15px;
    border-top: 1px solid #ddd;
    display: flex;
  }
  #newGroupName {
    flex-grow: 1;
    padding: 8px 12px;
    border-radius: 20px;
    border: 1px solid #ccc;
    outline: none;
  }
  #newGroupName:focus {
    border-color: #25d366;
  }
  #createGroupBtn {
    margin-left: 8px;
    background: #25d366;
    border: none;
    color: white;
    padding: 8px 15px;
    border-radius: 20px;
    cursor: pointer;
    font-weight: 600;
  }

  /* Chat Page */
  #chatPage {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    background: #ece5dd;
  }
  #chatHeader {
    background: #075e54;
    color: white;
    padding: 15px 20px;
    font-weight: 600;
    font-size: 1.1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  #chatHeader button {
    background: transparent;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
  }
  #messages {
    flex-grow: 1;
    padding: 20px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
  }

  /* Message bubbles */
  .message {
    max-width: 60%;
    margin-bottom: 12px;
    padding: 10px 15px;
    border-radius: 7.5px;
    font-size: 0.9rem;
    line-height: 1.3;
    position: relative;
    word-wrap: break-word;
    box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
  }
  .message.sent {
    background-color: #dcf8c6;
    align-self: flex-end;
    border-bottom-right-radius: 0;
  }
  .message.sent .username {
    display: none;
  }
  .message.received {
    background-color: white;
    align-self: flex-start;
    border-bottom-left-radius: 0;
  }
  .message .username {
    font-weight: 600;
    font-size: 0.75rem;
    color: #444;
    margin-bottom: 3px;
  }
  .message img {
    max-width: 200px;
    border-radius: 10px;
    margin-top: 5px;
  }

  /* Input area */
  #messageForm {
    background: white;
    padding: 12px 20px;
    display: flex;
    align-items: center;
    border-top: 1px solid #ddd;
  }
  #messageInput {
    flex-grow: 1;
    padding: 10px 15px;
    border-radius: 25px;
    border: 1px solid #ddd;
    outline: none;
    font-size: 1rem;
  }
  #messageInput:focus {
    border-color: #25d366;
  }
  #emojiBtn, #imageInputLabel {
    cursor: pointer;
    margin-left: 10px;
    font-size: 1.5rem;
    color: #888;
    user-select: none;
  }
  #sendBtn {
    background: #25d366;
    border: none;
    color: white;
    padding: 10px 18px;
    border-radius: 25px;
    margin-left: 10px;
    cursor: pointer;
    font-weight: 600;
  }
  #sendBtn:disabled {
    background: #a5d6a7;
    cursor: not-allowed;
  }

  /* Login Section */
  #login-section {
    display: flex;
    height: 100vh;
    justify-content: center;
    align-items: center;
    flex-direction: column;
  }
  #login-section input {
    padding: 12px 15px;
    font-size: 1rem;
    border-radius: 25px;
    border: 1px solid #ddd;
    outline: none;
    margin-bottom: 15px;
    width: 250px;
  }
  #login-section button {
    background: #25d366;
    border: none;
    color: white;
    padding: 12px 30px;
    font-size: 1rem;
    border-radius: 25px;
    cursor: pointer;
    font-weight: 600;
  }
</style>
</head>
<body>

<div id="login-section">
  <input id="username-input" type="text" placeholder="Enter your name" />
  <button id="login-btn">Login</button>
</div>

<div class="app-container hidden" id="chat-ui" style="display:none;">

  <!-- Groups Sidebar -->
  <div id="groupsPage">
    <header>Groups</header>
    <div id="groupsList">Loading groups...</div>
    <form id="newGroupForm" onsubmit="event.preventDefault(); createGroup();">
      <input id="newGroupName" type="text" placeholder="New group name" autocomplete="off" />
      <button id="createGroupBtn" type="submit">Create</button>
    </form>
  </div>

  <!-- Chat Window -->
  <div id="chatPage" class="hidden flex flex-col">
    <div id="chatHeader">
      <button onclick="backToGroups()">‚Üê</button>
      <div id="groupTitle">Select a group</div>
      <div id="currentUserLabel" title="You"></div>
    </div>

    <div id="messages"></div>

    <form id="messageForm" onsubmit="event.preventDefault(); sendMessage();">
      <input
        id="messageInput"
        type="text"
        placeholder="Type a message"
        autocomplete="off"
      />
      <label id="emojiBtn" title="Insert emoji" for="dummy" style="user-select:none;">üòä</label>
      <label id="imageInputLabel" title="Attach image" for="imageInput" style="user-select:none;">üìé</label>
      <input type="file" id="imageInput" accept="image/*" style="display:none" onchange="previewImage(event)" />
      <button id="sendBtn" type="submit">Send</button>
    </form>
  </div>

</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    onSnapshot,
    query,
    orderBy,
    doc,
    getDocs,
    deleteDoc,
    serverTimestamp,
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import {
    getStorage,
    ref,
    uploadBytes,
    getDownloadURL,
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDuGHDotdc-EZRxyyJLrWXyLsi2dLhSHm4",
    authDomain: "chatting-fd641.firebaseapp.com",
    projectId: "chatting-fd641",
    storageBucket: "chatting-fd641.appspot.com",
    messagingSenderId: "535384451291",
    appId: "1:535384451291:web:828f60686d81be018b44fe",
    measurementId: "G-RKS4CFZPJ4",
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);

  let currentUser = null;
  let selectedImage = null;
  let currentGroupId = null;

  const loginSection = document.getElementById("login-section");
  const chatUI = document.getElementById("chat-ui");
  const usernameInput = document.getElementById("username-input");
  const loginBtn = document.getElementById("login-btn");

  const groupsList = document.getElementById("groupsList");
  const messagesList = document.getElementById("messages");
  const currentUserLabel = document.getElementById("currentUserLabel");
  const groupTitle = document.getElementById("groupTitle");

  loginBtn.addEventListener("click", () => {
    const name = usernameInput.value.trim();
    if (!name) {
      alert("Please enter your name");
      return;
    }
    currentUser = {
      uid: "user-" + Math.random().toString(36).substring(2, 10),
      displayName: name,
    };
    loginSection.style.display = "none";
    chatUI.style.display = "flex";
    currentUserLabel.textContent = `You: ${currentUser.displayName}`;
    loadGroups();
  });

  async function loadGroups() {
    groupsList.innerHTML = "Loading groups...";
    const groupsRef = collection(db, "groups");
    onSnapshot(groupsRef, (snapshot) => {
      groupsList.innerHTML = "";
      if (snapshot.empty) {
        groupsList.innerHTML = "<p class='text-gray-500'>No groups yet. Create one!</p>";
        return;
      }
      snapshot.forEach((docSnap) => {
        const group = docSnap.data();
        const container = document.createElement("div");
        container.className =
          "p-3 border rounded mb-2 flex justify-between items-center hover:bg-blue-100 dark:hover:bg-gray-700";

        const nameDiv = document.createElement("div");
        nameDiv.textContent = group.name;
        nameDiv.className = "cursor-pointer flex-1";
        nameDiv.onclick = () => enterGroup(docSnap.id, group.name);

        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "‚ùå";
        deleteBtn.className = "ml-2 text-red-600 hover:text-red-800 text-sm";
        deleteBtn.onclick = (e) => {
          e.stopPropagation();
          if (confirm(`Delete group "${group.name}"?`)) {
            deleteGroup(docSnap.id);
          }
        };

        container.appendChild(nameDiv);
        container.appendChild(deleteBtn);
        groupsList.appendChild(container);
      });
    });
  }

  async function deleteGroup(groupId) {
    try {
      const messagesRef = collection(db, "groups", groupId, "messages");
      const messagesSnap = await getDocs(messagesRef);
      const deletePromises = messagesSnap.docs.map((doc) => deleteDoc(doc.ref));
      await Promise.all(deletePromises);
      await deleteDoc(doc(db, "groups", groupId));
      alert("Group deleted successfully.");
    } catch (error) {
      console.error("Error deleting group:", error);
      alert("Failed to delete group.");
    }
  }

  async function createGroup() {
    const groupNameInput = document.getElementById("newGroupName");
    const name = groupNameInput.value.trim();
    if (!name) return alert("Enter a group name");
    await addDoc(collection(db, "groups"), {
      name,
      createdAt: serverTimestamp(),
    });
    groupNameInput.value = "";
  }

  async function enterGroup(groupId, groupName) {
    currentGroupId = groupId;
    groupTitle.textContent = groupName;
    showChatUI();
    listenToMessages(groupId);
  }

  function showChatUI() {
    document.getElementById("groupsPage").classList.remove("hidden");
    document.getElementById("chatPage").classList.remove("hidden");
    // Hide groups sidebar on mobile or keep visible on desktop
  }

  async function sendMessage() {
    if (!currentGroupId) return alert("No group selected");
    const text = document.getElementById("messageInput").value.trim();
    if (!text && !selectedImage) return;

    let imageUrl = null;

    if (selectedImage) {
      const storageRef = ref(storage, "images/" + Date.now() + "-" + selectedImage.name);
      await uploadBytes(storageRef, selectedImage);
      imageUrl = await getDownloadURL(storageRef);
      selectedImage = null;
    }

    await addDoc(collection(db, "groups", currentGroupId, "messages"), {
      uid: currentUser.uid,
      username: currentUser.displayName,
      text: text || null,
      imageUrl: imageUrl || null,
      timestamp: new Date(),
    });

    document.getElementById("messageInput").value = "";
    document.getElementById("imageInput").value = "";
  }

  function listenToMessages(groupId) {
    const messagesRef = collection(db, "groups", groupId, "messages");
    const q = query(messagesRef, orderBy("timestamp", "asc"));
    onSnapshot(q, (snapshot) => {
      messagesList.innerHTML = "";
      snapshot.forEach((doc) => {
        const msg = doc.data();
        const div = document.createElement("div");
        div.className =
          "message " +
          (msg.uid === currentUser.uid ? "sent" : "received");

        div.innerHTML =
          `<div class="username">${msg.username}</div>` +
          (msg.text ? `<div>${msg.text}</div>` : "") +
          (msg.imageUrl ? `<img src="${msg.imageUrl}" alt="image"/>` : "");

        messagesList.appendChild(div);
      });
      messagesList.scrollTop = messagesList.scrollHeight;
    });
  }

  function previewImage(event) {
    selectedImage = event.target.files[0];
  }

  function backToGroups() {
    currentGroupId = null;
    document.getElementById("chatPage").classList.add("hidden");
    // Show groups sidebar clearly
  }

  window.createGroup = createGroup;
  window.sendMessage = sendMessage;
