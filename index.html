<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Only For Her - WhatsApp Style Chat</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Emoji Button -->
  <script src="https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@4.6.2/dist/index.min.js"></script>

  <!-- Firebase v10 SDK Modular -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      onSnapshot,
      query,
      orderBy,
      doc,
      getDocs,
      deleteDoc,
      updateDoc,
      serverTimestamp,
      setDoc,
      getDoc,
      arrayUnion,
      arrayRemove
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import {
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL,
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    // Firebase Config - Replace with your own
    const firebaseConfig = {
      apiKey: "AIzaSyDuGHDotdc-EZRxyyJLrWXyLsi2dLhSHm4",
      authDomain: "chatting-fd641.firebaseapp.com",
      projectId: "chatting-fd641",
      storageBucket: "chatting-fd641.appspot.com",
      messagingSenderId: "535384451291",
      appId: "1:535384451291:web:828f60686d81be018b44fe",
      measurementId: "G-RKS4CFZPJ4",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // Current user info and current group id
    let currentUser = null;
    let currentGroupId = null;
    let selectedImage = null;
    let typingTimeout = null;
    let isTyping = false;

    // DOM elements
    const loginSection = document.getElementById("login-section");
    const chatUI = document.getElementById("chat-ui");
    const usernameInput = document.getElementById("username-input");
    const loginBtn = document.getElementById("login-btn");

    const groupsList = document.getElementById("groupsList");
    const messagesList = document.getElementById("messages");
    const currentUserLabel = document.getElementById("currentUserLabel");
    const groupTitle = document.getElementById("groupTitle");
    const typingLabel = document.getElementById("typingLabel");
    const themeToggleBtn = document.getElementById("themeToggleBtn");

    // Emoji picker setup
    let emojiPicker;

    loginBtn.addEventListener("click", () => {
      const name = usernameInput.value.trim();
      if (!name) {
        alert("Please enter your name");
        return;
      }
      currentUser = {
        uid: "user-" + Math.random().toString(36).substring(2, 10),
        displayName: name,
      };
      loginSection.style.display = "none";
      chatUI.style.display = "flex";
      currentUserLabel.textContent = `Logged in as: ${currentUser.displayName}`;
      loadGroups();
      initEmojiPicker();
      loadTheme();
    });

    async function loadGroups() {
      groupsList.innerHTML = "Loading groups...";
      const groupsRef = collection(db, "groups");
      const q = query(groupsRef, orderBy("createdAt", "desc"));

      onSnapshot(q, (snapshot) => {
        groupsList.innerHTML = "";
        if (snapshot.empty) {
          groupsList.innerHTML = `<p class="text-gray-500 dark:text-gray-400 text-center">No groups yet. Create one!</p>`;
          return;
        }
        snapshot.forEach((docSnap) => {
          const group = docSnap.data();
          const container = document.createElement("div");
          container.className = "p-3 border rounded mb-2 flex justify-between items-center cursor-pointer hover:bg-blue-100 dark:hover:bg-gray-700 transition";

          const nameDiv = document.createElement("div");
          nameDiv.textContent = group.name;
          nameDiv.className = "flex-1 truncate";
          nameDiv.title = group.name;
          nameDiv.onclick = () => enterGroup(docSnap.id, group.name);

          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = "âŒ";
          deleteBtn.className = "ml-2 text-red-600 hover:text-red-800 text-sm";
          deleteBtn.onclick = async (e) => {
            e.stopPropagation();
            if (confirm(`Delete group "${group.name}"?`)) {
              await deleteGroup(docSnap.id);
            }
          };

          container.appendChild(nameDiv);
          container.appendChild(deleteBtn);
          groupsList.appendChild(container);
        });
      });
    }

    async function deleteGroup(groupId) {
      try {
        // Delete all messages inside group
        const messagesRef = collection(db, "groups", groupId, "messages");
        const messagesSnap = await getDocs(messagesRef);
        const deletePromises = messagesSnap.docs.map((msgDoc) => deleteDoc(msgDoc.ref));
        await Promise.all(deletePromises);

        // Delete the group doc itself
        await deleteDoc(doc(db, "groups", groupId));

        alert("Group deleted successfully.");
      } catch (error) {
        console.error("Error deleting group:", error);
        alert("Failed to delete group.");
      }
    }

    async function createGroup() {
      const groupNameInput = document.getElementById("newGroupName");
      const name = groupNameInput.value.trim();
      if (!name) {
        alert("Enter a group name");
        return;
      }
      await addDoc(collection(db, "groups"), {
        name,
        createdAt: serverTimestamp(),
      });
      groupNameInput.value = "";
    }

    async function enterGroup(groupId, groupName) {
      currentGroupId = groupId;
      groupTitle.textContent = groupName;
      typingLabel.textContent = "";
      showChatUI();
      listenToMessages(groupId);
      listenToTyping(groupId);
      listenToReadReceipts(groupId);
      markMessagesAsRead(groupId);
    }

    function showChatUI() {
      document.getElementById("groupsPage").classList.add("hidden");
      document.getElementById("chatPage").classList.remove("hidden");
    }

    function backToGroups() {
      currentGroupId = null;
      document.getElementById("chatPage").classList.add("hidden");
      document.getElementById("groupsPage").classList.remove("hidden");
      messagesList.innerHTML = "";
      typingLabel.textContent = "";
    }

    // Send message with text and optional image
    async function sendMessage() {
      if (!currentGroupId) {
        alert("No group selected");
        return;
      }
      const messageInput = document.getElementById("messageInput");
      const text = messageInput.value.trim();

      if (!text && !selectedImage) {
        alert("Type a message or select an image");
        return;
      }

      let imageUrl = null;
      if (selectedImage) {
        try {
          const storageRef = ref(storage, `groupImages/${currentGroupId}/${Date.now()}_${selectedImage.name}`);
          const uploadResult = await uploadBytes(storageRef, selectedImage);
          imageUrl = await getDownloadURL(uploadResult.ref);
          selectedImage = null;
          document.getElementById("imageInput").value = "";
        } catch (error) {
          alert("Image upload failed: " + error.message);
          return;
        }
      }

      try {
        await addDoc(collection(db, "groups", currentGroupId, "messages"), {
          uid: currentUser.uid,
          username: currentUser.displayName,
          text: text || "",
          imageUrl: imageUrl,
          timestamp: serverTimestamp(),
          reactions: {},
          readBy: [currentUser.uid], // mark sender as read immediately
        });
        messageInput.value = "";
        stopTyping();
      } catch (error) {
        alert("Failed to send message: " + error.message);
      }
    }

    // Listen to messages in current group
    function listenToMessages(groupId) {
      const messagesRef = collection(db, "groups", groupId, "messages");
      const q = query(messagesRef, orderBy("timestamp", "asc"));

      onSnapshot(q, (snapshot) => {
        messagesList.innerHTML = "";
        snapshot.forEach((docSnap) => {
          const msg = docSnap.data();
          const isMe = msg.uid === currentUser.uid;

          // Message container
          const msgDiv = document.createElement("div");
          msgDiv.className = `max-w-[70%] mb-2 flex flex-col rounded-lg p-2 
            ${isMe ? "bg-blue-600 text-white self-end" : "bg-gray-200 dark:bg-gray-700 text-black dark:text-white self-start"}`;

          // Username
          const usernameDiv = document.createElement("div");
          usernameDiv.textContent = msg.username;
          usernameDiv.className = "text-xs opacity-70 mb-1 font-semibold";
          msgDiv.appendChild(usernameDiv);

          // Text
          if (msg.text) {
            const textDiv = document.createElement("div");
            textDiv.textContent = msg.text;
            textDiv.className = "whitespace-pre-wrap break-words";
            msgDiv.appendChild(textDiv);
          }

          // Image
          if (msg.imageUrl) {
            const img = document.createElement("img");
            img.src = msg.imageUrl;
            img.alt = "sent image";
            img.className = "mt-2 rounded max-w-[200px] cursor-pointer shadow-lg";
            img.onclick = () => window.open(msg.imageUrl, "_blank");
            msgDiv.appendChild(img);
          }

          // Reactions container
          const reactionsDiv = document.createElement("div");
          reactionsDiv.className = "flex gap-1 mt-1";

          // Show reactions as emojis with counts
          if (msg.reactions) {
            for (const [emoji, users] of Object.entries(msg.reactions)) {
              const reactionSpan = document.createElement("span");
              reactionSpan.textContent = emoji + (users.length > 1 ? users.length : "");
              reactionSpan.className = `cursor-pointer select-none px-1 rounded ${
                users.includes(currentUser.uid) ? "bg-white/30" : "hover:bg-white/20"
              }`;
              reactionSpan.title = `Click to ${users.includes(currentUser.uid) ? "remove" : "add"} reaction`;

              reactionSpan.onclick = async () => {
                const msgRef = doc(db, "groups", currentGroupId, "messages", docSnap.id);
                if (users.includes(currentUser.uid)) {
                  // Remove reaction
                  await updateDoc(msgRef, {
                    [`reactions.${emoji}`]: arrayRemove(currentUser.uid),
                  });
                } else {
                  // Add reaction
                  await updateDoc(msgRef, {
                    [`reactions.${emoji}`]: arrayUnion(currentUser.uid),
                  });
                }
              };

              reactionsDiv.appendChild(reactionSpan);
            }
          }

          // Add reaction button
          const addReactionBtn = document.createElement("button");
          addReactionBtn.textContent = "ðŸ˜Š";
          addReactionBtn.className = "ml-1 cursor-pointer select-none px-1 rounded hover:bg-white/20";
          addReactionBtn.onclick = () => {
            emojiPicker.togglePicker(addReactionBtn);
            emojiPicker.pickerVisible = true;
            emojiPicker.pickerPosition = { top: 0, left: 0 };
            emojiPicker.on("emoji", async (emoji) => {
              const msgRef = doc(db, "groups", currentGroupId, "messages", docSnap.id);
              await updateDoc(msgRef, {
                [`reactions.${emoji}`]: arrayUnion(currentUser.uid),
              });
              emojiPicker.hidePicker();
            });
          };
          reactionsDiv.appendChild(addReactionBtn);

          msgDiv.appendChild(reactionsDiv);

          messagesList.appendChild(msgDiv);
        });

        scrollMessagesToBottom();
      });
    }

    function scrollMessagesToBottom() {
      messagesList.scrollTop = messagesList.scrollHeight;
    }

    // Typing indicator
    let typingDocRef = null;
    function listenToTyping(groupId) {
      typingDocRef = doc(db, "typingIndicators", groupId);
      onSnapshot(typingDocRef, (docSnap) => {
        if (!docSnap.exists()) {
          typingLabel.textContent = "";
          return;
        }
        const typingData = docSnap.data();
        const typingUsers = Object.entries(typingData)
          .filter(([uid, typing]) => typing && uid !== currentUser.uid)
          .map(([uid]) => uid);
        if (typingUsers.length > 0) {
          typingLabel.textContent = "Someone is typing...";
        } else {
          typingLabel.textContent = "";
        }
      });
    }

    async function startTyping() {
      if (!currentGroupId) return;
      if (isTyping) return;
      isTyping = true;
      await setDoc(doc(db, "typingIndicators", currentGroupId), {
        [currentUser.uid]: true,
      }, { merge: true });
      if (typingTimeout) clearTimeout(typingTimeout);
      typingTimeout = setTimeout(stopTyping, 3000);
    }

    async function stopTyping() {
      if (!currentGroupId) return;
      isTyping = false;
      await setDoc(doc(db, "typingIndicators", currentGroupId), {
        [currentUser.uid]: false,
      }, { merge: true });
    }

    // Listen to read receipts and update message display accordingly
    function listenToReadReceipts(groupId) {
      // This example marks messages read by current user when entering group
      // You can extend to show read status per message with small ticks or avatars
    }

    // Mark messages as read (add currentUser.uid to readBy array)
    async function markMessagesAsRead(groupId) {
      const messagesRef = collection(db, "groups", groupId, "messages");
      const q = query(messagesRef);
      const snap = await getDocs(q);
      const batchPromises = [];
      snap.forEach((msgDoc) => {
        const data = msgDoc.data();
        if (!data.readBy || !data.readBy.includes(currentUser.uid)) {
          batchPromises.push(
            updateDoc(msgDoc.ref, {
              readBy: arrayUnion(currentUser.uid),
            })
          );
        }
      });
      await Promise.all(batchPromises);
    }

    // Emoji picker for message input
    function initEmojiPicker() {
      emojiPicker = new EmojiButton({
        position: "top-start",
        theme: "auto",
      });
      const emojiBtn = document.getElementById("emojiBtn");
      emojiPicker.on("emoji", (emoji) => {
        const input = document.getElementById("messageInput");
        input.value += emoji;
        input.focus();
      });
      emojiBtn.addEventListener("click", () => emojiPicker.togglePicker(emojiBtn));
    }

    // Handle image file selection
    const imageInput = document.getElementById("imageInput");
    imageInput.addEventListener("change", (e) => {
      if (e.target.files.length > 0) {
        selectedImage = e.target.files[0];
      } else {
        selectedImage = null;
      }
    });

    // Send message on Enter key (if not shift)
    const messageInput = document.getElementById("messageInput");
    messageInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      } else {
        startTyping();
      }
    });

    // Theme toggle
    themeToggleBtn.addEventListener("click", () => {
      if (document.documentElement.classList.contains("dark")) {
        document.documentElement.classList.remove("dark");
        localStorage.setItem("theme", "light");
      } else {
        document.documentElement.classList.add("dark");
        localStorage.setItem("theme", "dark");
      }
    });

    function loadTheme() {
      const savedTheme = localStorage.getItem("theme");
      if (savedTheme === "dark") {
        document.documentElement.classList.add("dark");
      }
    }

    // Logout user - for simplicity reload page
    document.getElementById("logoutBtn").addEventListener("click", () => {
      location.reload();
    });

    // Attach create group button
    document.getElementById("createGroupBtn").addEventListener("click", createGroup);

    // Back button on chat
    document.getElementById("backBtn").addEventListener("click", backToGroups);
  </script>

  <style>
    body, html {
      height: 100%;
      background-color: #f9fafb;
    }
    /* Scrollbar for messages */
    #messages {
      scrollbar-width: thin;
      scrollbar-color: #a0aec0 transparent;
    }
    #messages::-webkit-scrollbar {
      width: 6px;
    }
    #messages::-webkit-scrollbar-thumb {
      background-color: #a0aec0;
      border-radius: 3px;
    }
  </style>
</head>
<body class="dark:bg-gray-900 dark:text-white">

  <!-- Login Section -->
  <section id="login-section" class="flex flex-col justify-center items-center h-screen bg-gray-100 dark:bg-gray-800">
    <h1 class="text-3xl font-bold mb-6">Only For Her - Login</h1>
    <input
      id="username-input"
      type="text"
      placeholder="Enter your name"
      class="p-3 border rounded w-64 mb-4 focus:outline-blue-500 dark:bg-gray-700 dark:border-gray-600"
    />
    <button
      id="login-btn"
      class="bg-blue-600 text-white px-6 py-3 rounded hover:bg-blue-700 transition"
    >
      Login
    </button>
  </section>

  <!-- Main Chat UI -->
  <section
    id="chat-ui"
    class="hidden h-screen flex flex-col"
  >
    <div class="flex h-full">
      <!-- Groups List Sidebar -->
      <aside id="groupsPage" class="w-72 border-r border-gray-300 dark:border-gray-700 p-4 overflow-y-auto">
        <h2 class="text-xl font-semibold mb-3">Groups</h2>
        <input
          type="text"
          id="newGroupName"
          placeholder="New group name"
          class="w-full mb-2 p-2 border rounded dark:bg-gray-700 dark:border-gray-600"
        />
        <button
          id="createGroupBtn"
          class="w-full bg-green-600 text-white rounded py-2 hover:bg-green-700 transition mb-4"
        >
          Create Group
        </button>
        <div id="groupsList" class="overflow-y-auto max-h-[calc(100vh-180px)]"></div>
        <button
          id="logoutBtn"
          class="mt-10 w-full bg-red-600 text-white rounded py-2 hover:bg-red-700 transition"
        >
          Logout
        </button>
      </aside>

      <!-- Chat Page -->
      <main
        id="chatPage"
        class="flex-1 flex flex-col hidden"
      >
        <header
          class="flex items-center justify-between p-4 border-b border-gray-300 dark:border-gray-700"
        >
          <button
            id="backBtn"
            class="text-blue-600 dark:text-blue-400 hover:underline"
            aria-label="Back to groups"
          >
            &larr; Groups
          </button>
          <h2
            id="groupTitle"
            class="text-xl font-semibold truncate max-w-[60vw]"
          >
            Select a group
          </h2>
          <button
            id="themeToggleBtn"
            title="Toggle Dark/Light Mode"
            class="text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white transition text-2xl"
          >
            ðŸŒ“
          </button>
        </header>

        <div
          id="messages"
          class="flex-1 p-4 overflow-y-auto bg-gray-50 dark:bg-gray-800"
          style="scroll-behavior: smooth;"
        >
          <!-- Messages will appear here -->
        </div>

        <div
          class="px-4 py-2 border-t border-gray-300 dark:border-gray-700 flex items-center gap-2 bg-white dark:bg-gray-900"
        >
          <button
            id="emojiBtn"
            title="Insert emoji"
            class="text-2xl select-none cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700 rounded p-1"
          >
            ðŸ˜Š
          </button>
          <textarea
            id="messageInput"
            rows="1"
            placeholder="Type a message"
            class="flex-grow resize-none border rounded p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white focus:outline-blue-500"
          ></textarea>
          <input
            type="file"
            accept="image/*"
            id="imageInput"
            class="hidden"
          />
          <label
            for="imageInput"
            class="cursor-pointer text-2xl select-none hover:bg-gray-200 dark:hover:bg-gray-700 rounded p-1"
            title="Attach image"
          >
            ðŸ“Ž
          </label>
          <button
            onclick="sendMessage()"
            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded"
          >
            Send
          </button>
        </div>

        <div
          id="typingLabel"
          class="px-4 py-1 text-sm text-gray-600 dark:text-gray-400 italic"
        ></div>
      </main>
    </div>
  </section>
</body>
</html>
