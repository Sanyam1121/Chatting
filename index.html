<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Only For Her - WhatsApp Style Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@4.6.2/dist/index.min.js"></script>
  <style>
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-thumb {
      background-color: rgba(100, 116, 139, 0.5);
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background-color: rgba(100, 116, 139, 0.8);
    }
    /* For voice record button animation */
    .recording {
      animation: pulse 1s infinite alternate;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 6px #dc2626; }
      100% { box-shadow: 0 0 16px #b91c1c; }
    }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 flex h-screen select-none transition-colors duration-500">

  <!-- LOGIN SCREEN -->
  <div id="login-section" class="m-auto max-w-sm w-full bg-white dark:bg-gray-800 rounded-lg shadow-lg p-8">
    <h1 class="text-2xl font-semibold mb-6 text-center">Welcome to Only For Her</h1>
    <input id="username-input" type="text" placeholder="Enter your name" 
      class="w-full border border-gray-300 rounded-lg p-3 mb-5 text-gray-900 dark:text-gray-100 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500" />
    <button id="login-btn" class="w-full bg-green-600 hover:bg-green-700 transition-colors text-white font-semibold py-3 rounded-lg shadow-md">Join Chat</button>
  </div>

  <!-- CHAT APP -->
  <div id="chat-ui" class="hidden flex flex-1 max-w-7xl mx-auto bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden">

    <!-- LEFT SIDEBAR: Groups/Chats -->
    <div id="groupsPage" class="w-80 flex flex-col border-r border-gray-300 dark:border-gray-700">
      <header class="flex items-center justify-between px-5 py-4 border-b border-gray-300 dark:border-gray-700">
        <h2 class="text-xl font-bold">Groups</h2>
        <span id="currentUserLabel" class="text-sm italic text-gray-500 dark:text-gray-400"></span>
      </header>

      <div id="groupsList" class="flex-1 overflow-y-auto p-4 space-y-2 bg-gray-100 dark:bg-gray-900">
        <!-- Groups will load here -->
      </div>

      <div class="p-4 border-t border-gray-300 dark:border-gray-700 flex gap-2">
        <input id="newGroupName" type="text" placeholder="New group name" 
          class="flex-1 border border-gray-300 dark:border-gray-700 rounded-lg p-2 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-green-500" />
        <button onclick="createGroup()" 
          class="bg-green-600 hover:bg-green-700 text-white font-semibold px-4 rounded-lg shadow-md transition-colors">Create</button>
      </div>
      <div class="p-3 border-t border-gray-300 dark:border-gray-700 flex items-center justify-between gap-4">
        <label for="darkModeToggle" class="cursor-pointer select-none text-gray-700 dark:text-gray-300 flex items-center gap-2">
          <input type="checkbox" id="darkModeToggle" class="hidden" />
          <svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" >
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 3v1m0 16v1m8.66-12.34l-.7.7m-14.9 0l-.7-.7M21 12h-1M4 12H3m16.66 4.34l-.7-.7m-14.9 0l-.7.7M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
          </svg>
          <span>Dark Mode</span>
        </label>
      </div>
    </div>

    <!-- RIGHT MAIN CHAT AREA -->
    <div id="chatPage" class="hidden flex flex-col flex-1 bg-white dark:bg-gray-900">
      <!-- Chat header -->
      <header class="flex items-center justify-between border-b border-gray-300 dark:border-gray-700 px-6 py-3 bg-gray-50 dark:bg-gray-800 shadow-sm">
        <button onclick="backToGroups()" class="text-blue-600 dark:text-blue-400 font-semibold hover:underline">‚Üê Back</button>
        <h2 id="groupTitle" class="text-lg font-semibold truncate max-w-xs"></h2>
        <div id="typingIndicator" class="text-sm italic text-gray-600 dark:text-gray-400"></div>
      </header>

      <!-- Messages list -->
      <div id="messages" class="flex-1 p-6 overflow-y-auto space-y-3 bg-gray-50 dark:bg-gray-900 scrollbar-thin scrollbar-thumb-gray-400 dark:scrollbar-thumb-gray-700 flex flex-col">
        <!-- Messages appended here -->
      </div>

      <!-- Message input area -->
      <footer class="flex items-center gap-3 px-6 py-4 border-t border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-800">
        <button id="emojiBtn" class="text-2xl hover:bg-gray-200 dark:hover:bg-gray-700 p-2 rounded-full transition"><span>üòä</span></button>
        <input
          id="messageInput"
          type="text"
          placeholder="Type a message"
          autocomplete="off"
          class="flex-1 bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-full py-2 px-4 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500"
          onkeydown="if(event.key==='Enter'){sendMessage();}"
        />
        <input type="file" id="imageInput" accept="image/*" onchange="previewImage(event)" class="hidden" />
        <button onclick="document.getElementById('imageInput').click()" 
          class="text-xl hover:bg-gray-200 dark:hover:bg-gray-700 p-2 rounded-full transition" title="Send Image">üì∑</button>

        <button id="recordBtn" title="Record Voice Note" class="text-red-600 hover:bg-red-100 dark:hover:bg-red-900 p-2 rounded-full transition">
          üé§
        </button>

        <button onclick="sendMessage()" 
          class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-5 py-2 rounded-full shadow-md transition">Send</button>
      </footer>
    </div>
  </div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    onSnapshot,
    query,
    orderBy,
    doc,
    getDocs,
    deleteDoc,
    serverTimestamp,
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import {
    getStorage,
    ref,
    uploadBytes,
    getDownloadURL,
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDuGHDotdc-EZRxyyJLrWXyLsi2dLhSHm4",
    authDomain: "chatting-fd641.firebaseapp.com",
    projectId: "chatting-fd641",
    storageBucket: "chatting-fd641.appspot.com",
    messagingSenderId: "535384451291",
    appId: "1:535384451291:web:828f60686d81be018b44fe",
    measurementId: "G-RKS4CFZPJ4",
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);

  let currentUser = null;
  let selectedImage = null;
  let currentGroupId = null;

  const loginSection = document.getElementById("login-section");
  const chatUI = document.getElementById("chat-ui");
  const usernameInput = document.getElementById("username-input");
  const loginBtn = document.getElementById("login-btn");

  const groupsList = document.getElementById("groupsList");
  const messagesList = document.getElementById("messages");
  const currentUserLabel = document.getElementById("currentUserLabel");
  const groupTitle = document.getElementById("groupTitle");

  loginBtn.addEventListener("click", () => {
    const name = usernameInput.value.trim();
    if (!name) {
      alert("Please enter your name");
      return;
    }
    currentUser = {
      uid: "user-" + Math.random().toString(36).substring(2, 10),
      displayName: name,
    };
    loginSection.style.display = "none";
    chatUI.style.display = "flex";
    currentUserLabel.textContent = `Logged in as: ${currentUser.displayName}`;
    loadGroups();
  });

  async function loadGroups() {
    groupsList.innerHTML = "Loading groups...";
    const groupsRef = collection(db, "groups");
    onSnapshot(groupsRef, (snapshot) => {
      groupsList.innerHTML = "";
      if (snapshot.empty) {
        groupsList.innerHTML = "<p class='text-gray-500'>No groups yet. Create one!</p>";
        return;
      }
      snapshot.forEach((docSnap) => {
        const group = docSnap.data();
        const container = document.createElement("div");
        container.className =
          "p-3 border rounded mb-2 flex justify-between items-center hover:bg-blue-100 dark:hover:bg-gray-700";

        const nameDiv = document.createElement("div");
        nameDiv.textContent = group.name;
        nameDiv.className = "cursor-pointer flex-1";
        nameDiv.onclick = () => enterGroup(docSnap.id, group.name);

        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "‚ùå";
        deleteBtn.className = "ml-2 text-red-600 hover:text-red-800 text-sm";
        deleteBtn.onclick = (e) => {
          e.stopPropagation();
          if (confirm(`Delete group "${group.name}"?`)) {
            deleteGroup(docSnap.id);
          }
        };

        container.appendChild(nameDiv);
        container.appendChild(deleteBtn);
        groupsList.appendChild(container);
      });
    });
  }

  async function deleteGroup(groupId) {
    try {
      const messagesRef = collection(db, "groups", groupId, "messages");
      const messagesSnap = await getDocs(messagesRef);
      const deletePromises = messagesSnap.docs.map((doc) => deleteDoc(doc.ref));
      await Promise.all(deletePromises);
      await deleteDoc(doc(db, "groups", groupId));
      alert("Group deleted successfully.");
    } catch (error) {
      console.error("Error deleting group:", error);
      alert("Failed to delete group.");
    }
  }

  async function createGroup() {
    const groupNameInput = document.getElementById("newGroupName");
    const name = groupNameInput.value.trim();
    if (!name) return alert("Enter a group name");
    await addDoc(collection(db, "groups"), {
      name,
      createdAt: serverTimestamp(),
    });
    groupNameInput.value = "";
  }

  async function enterGroup(groupId, groupName) {
    currentGroupId = groupId;
    groupTitle.textContent = groupName;
    showChatUI();
    listenToMessages(groupId);
  }

  function showChatUI() {
    document.getElementById("groupsPage").classList.add("hidden");
    document.getElementById("chatPage").classList.remove("hidden");
  }

  async function sendMessage() {
    if (!currentGroupId) return alert("No group selected");
    const text = document.getElementById("messageInput").value.trim();
    if (!text && !selectedImage) return;
    let imageUrl = null;

    if (selectedImage) {
      const storageRef = ref(storage, "images/" + Date.now() + "-" + selectedImage.name);
      await uploadBytes(storageRef, selectedImage);
      imageUrl = await getDownloadURL(storageRef);
      selectedImage = null;
    }

    await addDoc(collection(db, "groups", currentGroupId, "messages"), {
      uid: currentUser.uid,
      username: currentUser.displayName,
      text: text || null,
      imageUrl: imageUrl || null,
      timestamp: new Date(),
    });

    document.getElementById("messageInput").value = "";
    document.getElementById("imageInput").value = "";
  }

  function listenToMessages(groupId) {
    const messagesRef = collection(db, "groups", groupId, "messages");
    const q = query(messagesRef, orderBy("timestamp", "asc"));
    onSnapshot(q, (snapshot) => {
      messagesList.innerHTML = "";
      snapshot.forEach((doc) => {
        const msg = doc.data();
        const div = document.createElement("div");
        div.className =
          "p-2 rounded-lg max-w-[70%] mb-2 flex flex-col " +
          (msg.uid === currentUser.uid
            ? "bg-blue-500 text-white self-end"
            : "bg-gray-200 text-black self-start dark:bg-gray-700 dark:text-white");

        div.innerHTML =
          `<div class="text-xs mb-1 opacity-70">${msg.username}</div>` +
          (msg.text ? `<div>${msg.text}</div>` : "") +
          (msg.imageUrl ? `<img src="${msg.imageUrl}" class="mt-2 rounded shadow max-w-[200px]"/>` : "");

        messagesList.appendChild(div);
      });
      messagesList.scrollTop = messagesList.scrollHeight;
    });
  }

  function previewImage(event) {
    selectedImage = event.target.files[0];
  }

  function backToGroups() {
    currentGroupId = null;
    document.getElementById("chatPage").classList.add("hidden");
    document.getElementById("groupsPage").classList.remove("hidden");
  }

  window.createGroup = createGroup;
  window.sendMessage = sendMessage;
  window.previewImage = previewImage;
  window.backToGroups = backToGroups;

  window.onload = () => {
    const picker = new EmojiButton();
    const trigger = document.querySelector("#emojiBtn");
    picker.on("emoji", (emoji) => {
      document.getElementById("messageInput").value += emoji;
    });
    trigger.addEventListener("click", () => picker.togglePicker(trigger));
  };
</script>

</body>
</html>
