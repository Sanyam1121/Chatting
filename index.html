<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chat App - WhatsApp Style with Google Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@4.6.2/dist/index.min.js"></script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import {
        getFirestore,
        collection,
        addDoc,
        onSnapshot,
        query,
        orderBy,
        doc,
        getDocs,
        deleteDoc,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
      import {
        getStorage,
        ref,
        uploadBytes,
        getDownloadURL,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
      import {
        getAuth,
        signInWithPopup,
        GoogleAuthProvider,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

      // Your Firebase config
      const firebaseConfig = {
        apiKey: "AIzaSyDuGHDotdc-EZRxyyJLrWXyLsi2dLhSHm4",
        authDomain: "chatting-fd641.firebaseapp.com",
        projectId: "chatting-fd641",
        storageBucket: "chatting-fd641.appspot.com",
        messagingSenderId: "535384451291",
        appId: "1:535384451291:web:828f60686d81be018b44fe",
        measurementId: "G-RKS4CFZPJ4",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const storage = getStorage(app);
      const auth = getAuth(app);
      const provider = new GoogleAuthProvider();

      let currentUser = null;
      let selectedImage = null;
      let currentGroupId = null;

      window.onload = () => {
        const picker = new EmojiButton();
        const trigger = document.querySelector("#emojiBtn");
        picker.on("emoji", (emoji) => {
          document.getElementById("messageInput").value += emoji;
        });
        trigger.addEventListener("click", () => picker.togglePicker(trigger));

        document
          .getElementById("googleSignInBtn")
          .addEventListener("click", googleSignIn);

        document
          .getElementById("signOutBtn")
          .addEventListener("click", () => signOut(auth));

        onAuthStateChanged(auth, (user) => {
          if (user) {
            currentUser = {
              uid: user.uid,
              displayName: user.displayName,
            };
            document.getElementById("login-section").style.display = "none";
            document.getElementById("chat-ui").style.display = "flex";
            document.getElementById(
              "currentUserLabel"
            ).textContent = `Logged in as: ${currentUser.displayName}`;
            loadGroups();
          } else {
            currentUser = null;
            document.getElementById("login-section").style.display = "block";
            document.getElementById("chat-ui").style.display = "none";
          }
        });
      };

      async function googleSignIn() {
        try {
          await signInWithPopup(auth, provider);
          // onAuthStateChanged listener will handle UI update and loadGroups
        } catch (error) {
          alert("Google Sign-In failed: " + error.message);
        }
      }

      function loadGroups() {
        const groupsList = document.getElementById("groupsList");
        groupsList.innerHTML = "Loading groups...";
        const groupsRef = collection(db, "groups");
        onSnapshot(groupsRef, (snapshot) => {
          groupsList.innerHTML = "";
          if (snapshot.empty) {
            groupsList.innerHTML =
              "<p class='text-gray-500'>No groups yet. Create one!</p>";
            return;
          }
          snapshot.forEach((docSnap) => {
            const group = docSnap.data();
            const container = document.createElement("div");
            container.className =
              "p-3 border rounded mb-2 flex justify-between items-center hover:bg-blue-100 dark:hover:bg-gray-700";

            const nameDiv = document.createElement("div");
            nameDiv.textContent = group.name;
            nameDiv.className = "cursor-pointer flex-1";
            nameDiv.onclick = () => enterGroup(docSnap.id, group.name);

            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "❌";
            deleteBtn.className =
              "ml-2 text-red-600 hover:text-red-800 text-sm";
            deleteBtn.onclick = (e) => {
              e.stopPropagation();
              if (confirm(`Delete group "${group.name}"?`)) {
                deleteGroup(docSnap.id);
              }
            };

            container.appendChild(nameDiv);
            container.appendChild(deleteBtn);
            groupsList.appendChild(container);
          });
        });
      }

      async function deleteGroup(groupId) {
        const messagesRef = collection(db, "groups", groupId, "messages");
        const messagesSnap = await getDocs(messagesRef);
        const deletePromises = messagesSnap.docs.map((doc) => deleteDoc(doc.ref));
        await Promise.all(deletePromises);
        await deleteDoc(doc(db, "groups", groupId));
        alert("Group deleted successfully.");
      }

      window.createGroup = async () => {
        const groupNameInput = document.getElementById("newGroupName");
        const name = groupNameInput.value.trim();
        if (!name) return alert("Enter a group name");
        await addDoc(collection(db, "groups"), {
          name,
          createdAt: serverTimestamp(),
        });
        groupNameInput.value = "";
      };

      function enterGroup(groupId, groupName) {
        currentGroupId = groupId;
        document.getElementById("groupTitle").textContent = groupName;
        document.getElementById("groupsPage").classList.add("hidden");
        document.getElementById("chatPage").classList.remove("hidden");
        listenToMessages(groupId);
      }

      window.backToGroups = () => {
        currentGroupId = null;
        document.getElementById("chatPage").classList.add("hidden");
        document.getElementById("groupsPage").classList.remove("hidden");
      };

      window.sendMessage = async () => {
        if (!currentGroupId) return alert("No group selected");
        const text = document.getElementById("messageInput").value.trim();
        if (!text && !selectedImage) return;
        let imageUrl = null;
        if (selectedImage) {
          const storageRef = ref(
            storage,
            "images/" + Date.now() + "-" + selectedImage.name
          );
          await uploadBytes(storageRef, selectedImage);
          imageUrl = await getDownloadURL(storageRef);
          selectedImage = null;
        }
        await addDoc(collection(db, "groups", currentGroupId, "messages"), {
          uid: currentUser.uid,
          username: currentUser.displayName,
          text: text || null,
          imageUrl: imageUrl || null,
          timestamp: serverTimestamp(),
        });
        document.getElementById("messageInput").value = "";
        document.getElementById("imageInput").value = "";
      };

      function listenToMessages(groupId) {
        const messagesRef = collection(db, "groups", groupId, "messages");
        const q = query(messagesRef, orderBy("timestamp", "asc"));
        onSnapshot(q, (snapshot) => {
          const messagesList = document.getElementById("messages");
          messagesList.innerHTML = "";
          snapshot.forEach((doc) => {
            const msg = doc.data();
            const div = document.createElement("div");
            div.className =
              "p-2 rounded-lg max-w-[70%] mb-2 flex flex-col " +
              (msg.uid === currentUser.uid
                ? "bg-green-500 text-white self-end"
                : "bg-gray-300 text-black self-start");
            div.innerHTML =
              `<div class='text-xs mb-1 opacity-70'>${msg.username}</div>` +
              (msg.text ? `<div>${msg.text}</div>` : "") +
              (msg.imageUrl
                ? `<img src='${msg.imageUrl}' class='mt-2 rounded shadow max-w-[200px]'/>`
                : "");
            messagesList.appendChild(div);
          });
          messagesList.scrollTop = messagesList.scrollHeight;
        });
      }

      window.previewImage = (event) => {
        selectedImage = event.target.files[0];
      };
    </script>
  </head>
  <body
    class="min-h-screen bg-gray-100 dark:bg-gray-900 text-black dark:text-white flex flex-col items-center p-4"
  >
    <div
      id="login-section"
      class="w-full max-w-sm bg-white dark:bg-gray-800 rounded-lg shadow p-6 flex flex-col items-center"
    >
      <h1 class="text-xl font-bold mb-4">Sign in to Chat</h1>
      <button
        id="googleSignInBtn"
        class="bg-red-600 text-white px-4 py-2 rounded w-full hover:bg-red-700"
      >
        Sign in with Google
      </button>
    </div>

    <div
      id="chat-ui"
      class="hidden w-full max-w-4xl flex flex-col h-[80vh] border rounded-lg shadow bg-white dark:bg-gray-800"
    >
      <div
        class="flex items-center justify-between p-4 border-b dark:border-gray-700"
      >
        <h2 id="currentUserLabel" class="font-semibold"></h2>
        <button
          id="signOutBtn"
          class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700"
        >
          Sign Out
        </button>
      </div>

      <div id="groupsPage" class="p-4 overflow-auto flex-1">
        <h2 class="text-lg font-bold mb-3">Groups</h2>
        <input
          type="text"
          id="newGroupName"
          placeholder="New group name"
          class="border rounded px-3 py-2 w-full mb-2"
        />
        <button
          onclick="createGroup()"
          class="bg-blue-600 text-white px-4 py-2 rounded w-full mb-4 hover:bg-blue-700"
        >
          Create Group
        </button>
        <div id="groupsList" class="max-h-[40vh] overflow-auto"></div>
      </div>

      <div id="chatPage" class="hidden flex flex-col h-full">
        <div
          class="flex items-center justify-between border-b p-4 dark:border-gray-700"
        >
          <button
            onclick="backToGroups()"
            class="text-blue-600 dark:text-blue-400 hover:underline"
          >
            &larr; Back to Groups
          </button>
          <h2 id="groupTitle" class="text-lg font-bold"></h2>
          <div></div>
        </div>
        <div
          id="messages"
          class="flex-1 p-4 overflow-auto bg-gray-50 dark:bg-gray-900"
        ></div>
        <div class="flex items-center border-t p-3 space-x-2 dark:border-gray-700">
          <button
            id="emojiBtn"
            class="text-2xl hover:bg-gray-300 dark:hover:bg-gray-700 rounded px-2"
            title="Emoji Picker"
          >
            😊
          </button>
          <input
            type="text"
            id="messageInput"
            placeholder="Type a message"
            class="flex-1 border rounded px-3 py-2 dark:bg-gray-700 dark:border-gray-600"
          />
          <input
            type="file"
            id="imageInput"
            accept="image/*"
            onchange="previewImage(event)"
            class="hidden"
          />
          <button
            onclick="document.getElementById('imageInput').click()"
            class="text-xl hover:bg-gray-300 dark:hover:bg-gray-700 rounded px-2"
            title="Attach Image"
          >
            📎
          </button>
          <button
            onclick="sendMessage()"
            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
          >
            Send
          </button>
        </div>
      </div>
    </div>
  </body>
</html>
