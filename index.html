<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat App</title>
  <script type="module">
    // Firebase config - replace with your own
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      onSnapshot,
      query,
      orderBy,
      doc,
      setDoc,
      getDoc,
      updateDoc,
      arrayUnion
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBYATp_zUt5yd_yScWmLOXkTBvfkq4FgRw",
      authDomain: "chatweb-2333a.firebaseapp.com",
      projectId: "chatweb-2333a",
      storageBucket: "chatweb-2333a.appspot.com",
      messagingSenderId: "662874912383",
      appId: "1:662874912383:web:07c2e96d489ecb1aa04cbd"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentUser = null;
    let currentGroupId = null;

    const loginForm = document.getElementById("login-form");
    const usernameInput = document.getElementById("username");
    const groupNameInput = document.getElementById("group-name");
    const createGroupBtn = document.getElementById("create-group-btn");
    const sendBtn = document.getElementById("send-btn");
    const messageInput = document.getElementById("message-input");
    const messagesList = document.getElementById("messages-list");
    const groupsList = document.getElementById("groups-list");

    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const username = usernameInput.value.trim();
      if (!username) return;
      currentUser = { uid: username, name: username };
      document.getElementById("login-section").style.display = "none";
      document.getElementById("chat-ui").style.display = "flex";
      listenToGroups();
    });

    createGroupBtn.addEventListener("click", async () => {
      const groupName = groupNameInput.value.trim();
      if (!groupName) return;
      await addDoc(collection(db, "groups"), {
        name: groupName,
        createdAt: new Date(),
        members: [currentUser.uid]
      });
      groupNameInput.value = "";
    });

    sendBtn.addEventListener("click", async () => {
      const text = messageInput.value.trim();
      if (!text || !currentGroupId) return;
      await addDoc(collection(db, `groups/${currentGroupId}/messages`), {
        text,
        sender: currentUser.uid,
        timestamp: new Date()
      });
      messageInput.value = "";
    });

    function listenToGroups() {
      const groupsRef = collection(db, "groups");
      onSnapshot(groupsRef, (snapshot) => {
        groupsList.innerHTML = "";
        snapshot.forEach((doc) => {
          const group = doc.data();
          const groupId = doc.id;
          const groupDiv = document.createElement("div");
          groupDiv.className = "group-item";
          groupDiv.textContent = group.name;
          groupDiv.onclick = () => openGroupChat(groupId, group.name);
          groupsList.appendChild(groupDiv);
        });
      });
    }

    function openGroupChat(groupId, groupName) {
      currentGroupId = groupId;
      document.getElementById("current-group").textContent = groupName;
      const messagesRef = collection(db, `groups/${groupId}/messages`);
      const q = query(messagesRef, orderBy("timestamp"));

      onSnapshot(q, (snapshot) => {
        messagesList.innerHTML = "";
        snapshot.forEach((doc) => {
          const msg = doc.data();
          const div = document.createElement("div");
          div.textContent = `${msg.sender}: ${msg.text}`;
          div.className = msg.sender === currentUser.uid ? "sent" : "received";
          messagesList.appendChild(div);
        });
      });
    }
  </script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    #login-section {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    #chat-ui {
      display: none;
      flex: 1;
      flex-direction: row;
      height: 100%;
    }
    #groups-list {
      width: 30%;
      border-right: 1px solid #ccc;
      padding: 10px;
      overflow-y: auto;
    }
    #chat-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 10px;
    }
    #messages-list {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 10px;
    }
    .group-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }
    .sent {
      text-align: right;
      color: green;
    }
    .received {
      text-align: left;
      color: blue;
    }
  </style>
</head>
<body>
  <section id="login-section">
    <form id="login-form">
      <input id="username" placeholder="Enter your name" required />
      <button type="submit">Login</button>
    </form>
  </section>

  <section id="chat-ui">
    <div id="groups-list"></div>
    <div id="chat-section">
      <h3 id="current-group">Select a group</h3>
      <div id="messages-list"></div>
      <input id="message-input" placeholder="Type a message..." />
      <button id="send-btn">Send</button>
      <input id="group-name" placeholder="Group name..." />
      <button id="create-group-btn">Create Group</button>
    </div>
  </section>
</body>
</html>
