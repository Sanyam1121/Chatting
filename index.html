<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Firebase Chat Groups with Reactions</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
</head>
<body class="bg-gray-900 text-white">
  <div id="app" class="flex h-screen" style="display:none;">
    <!-- Sidebar for Groups -->
    <aside class="w-1/5 bg-gray-800 p-4 flex flex-col space-y-4">
      <h1 class="text-xl font-bold">Groups</h1>

      <!-- Group List -->
      <div id="groupList" class="flex flex-col gap-2 overflow-y-auto flex-1"></div>

      <!-- Create Group -->
      <form id="create-group-form" class="flex gap-2">
        <input
          id="group-name"
          type="text"
          placeholder="New Group"
          class="flex-1 p-2 bg-gray-700 rounded"
          required
        />
        <button type="submit" class="bg-green-600 px-2 rounded">âž•</button>
      </form>

      <button id="logout" class="bg-red-600 p-2 rounded">Logout</button>
    </aside>

    <!-- Chat Area -->
    <main class="flex-1 flex flex-col">
      <header class="p-4 border-b border-gray-700">
        <h2 id="chatTitle" class="text-xl font-semibold">Select a Group</h2>
      </header>
      <div id="chatMessages" class="flex-1 p-4 overflow-y-auto space-y-2"></div>
      <footer class="p-4 border-t border-gray-700 flex items-center gap-2">
        <input
          id="messageInput"
          type="text"
          placeholder="Type a message..."
          class="flex-1 p-2 bg-gray-800 rounded"
        />
        <button id="sendMessage" class="bg-blue-600 p-2 rounded">Send</button>
      </footer>
    </main>
  </div>

  <!-- Login Screen -->
  <div
    id="loginScreen"
    class="fixed inset-0 flex justify-center items-center bg-gray-900 z-50"
  >
    <div class="bg-gray-800 p-6 rounded w-80">
      <h2 class="text-xl mb-4">Login</h2>
      <input
        id="email"
        type="email"
        placeholder="Email"
        class="w-full p-2 mb-2 bg-gray-700 rounded"
      />
      <input
        id="password"
        type="password"
        placeholder="Password"
        class="w-full p-2 mb-2 bg-gray-700 rounded"
      />
      <button id="login" class="w-full bg-blue-600 p-2 rounded">Login</button>
      <button id="signup" class="w-full mt-2 bg-green-600 p-2 rounded">
        Sign Up
      </button>
    </div>
  </div>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyDuGHDotdc-EZRxyyJLrWXyLsi2dLhSHm4",
      authDomain: "chatting-fd641.firebaseapp.com",
      projectId: "chatting-fd641",
      storageBucket: "chatting-fd641.appspot.com",
      messagingSenderId: "535384451291",
      appId: "1:535384451291:web:828f60686d81be018b44fe",
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // DOM refs
    const loginScreen = document.getElementById("loginScreen");
    const app = document.getElementById("app");
    const loginBtn = document.getElementById("login");
    const signupBtn = document.getElementById("signup");
    const logoutBtn = document.getElementById("logout");
    const groupList = document.getElementById("groupList");
    const createGroupForm = document.getElementById("create-group-form");
    const groupNameInput = document.getElementById("group-name");
    const chatMessages = document.getElementById("chatMessages");
    const messageInput = document.getElementById("messageInput");
    const sendMessageBtn = document.getElementById("sendMessage");
    const chatTitle = document.getElementById("chatTitle");

    let currentGroupId = null;
    let unsubscribeMessages = null;

    // Emoji reactions to show
    const reactionEmojis = ["ðŸ‘", "â¤ï¸", "ðŸ˜‚", "ðŸ˜®", "ðŸ˜¢"];

    // Auth listener
    auth.onAuthStateChanged((user) => {
      if (user) {
        loginScreen.style.display = "none";
        app.style.display = "flex";
        loadGroups();
      } else {
        loginScreen.style.display = "flex";
        app.style.display = "none";
        if (unsubscribeMessages) {
          unsubscribeMessages();
          unsubscribeMessages = null;
        }
      }
    });

    // Auth actions
    loginBtn.onclick = () => {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      auth.signInWithEmailAndPassword(email, password).catch((err) => alert(err.message));
    };

    signupBtn.onclick = () => {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      auth.createUserWithEmailAndPassword(email, password).catch((err) => alert(err.message));
    };

    logoutBtn.onclick = () => auth.signOut();

    // Create group
    createGroupForm.onsubmit = async (e) => {
      e.preventDefault();
      const name = groupNameInput.value.trim();
      if (!name) return;

      await db.collection("groups").add({
        name,
        members: [auth.currentUser.uid],
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      });

      groupNameInput.value = "";
    };

    // Load groups
    function loadGroups() {
      db.collection("groups")
        .orderBy("createdAt")
        .onSnapshot((snapshot) => {
          groupList.innerHTML = "";
          snapshot.forEach((doc) => {
            const group = doc.data();
            const div = document.createElement("div");
            div.textContent = group.name;
            div.className =
              "cursor-pointer bg-gray-700 rounded-full px-3 py-2 text-center hover:bg-gray-600";
            div.onclick = () => selectGroup(doc.id, group.name);
            groupList.appendChild(div);
          });
        });
    }

    // Select group
    function selectGroup(id, name) {
      currentGroupId = id;
      chatTitle.textContent = name;

      // Unsubscribe previous messages listener if any
      if (unsubscribeMessages) {
        unsubscribeMessages();
        unsubscribeMessages = null;
      }

      unsubscribeMessages = db
        .collection("groups")
        .doc(id)
        .collection("messages")
        .orderBy("createdAt")
        .onSnapshot((snapshot) => {
          chatMessages.innerHTML = "";
          snapshot.forEach((doc) => {
            const data = doc.data();
            const messageId = doc.id;

            // Create message container
            const div = document.createElement("div");
            div.className = "bg-gray-800 p-2 rounded";

            // Message text
            const msgText = document.createElement("div");
            msgText.textContent = data.text;
            div.appendChild(msgText);

            // Reactions container
            const reactionsContainer = document.createElement("div");
            reactionsContainer.className = "flex space-x-2 mt-1";

            // Current user's uid
            const uid = auth.currentUser.uid;

            // Show reaction emojis with counts
            reactionEmojis.forEach((emoji) => {
              const count = data.reactions && data.reactions[emoji] ? data.reactions[emoji].length : 0;
              const userReacted = data.reactions && data.reactions[emoji] ? data.reactions[emoji].includes(uid) : false;

              const reactionBtn = document.createElement("button");
              reactionBtn.textContent = `${emoji} ${count || ""}`;
              reactionBtn.className = `text-sm px-1 rounded ${
                userReacted ? "bg-blue-600" : "bg-gray-700"
              }`;
              reactionBtn.onclick = async () => {
                await toggleReaction(id, messageId, emoji, uid);
              };
              reactionsContainer.appendChild(reactionBtn);
            });

            div.appendChild(reactionsContainer);

            chatMessages.appendChild(div);
          });
          chatMessages.scrollTop = chatMessages.scrollHeight;
        });
    }

    // Toggle reaction on a message
    async function toggleReaction(groupId, messageId, emoji, uid) {
      const msgRef = db.collection("groups").doc(groupId).collection("messages").doc(messageId);
      await db.runTransaction(async (transaction) => {
        const msgDoc = await transaction.get(msgRef);
        if (!msgDoc.exists) return;

        const reactions = msgDoc.data().reactions || {};
        const usersReacted = reactions[emoji] || [];

        if (usersReacted.includes(uid)) {
          // Remove reaction
          reactions[emoji] = usersReacted.filter((userId) => userId !== uid);
          if (reactions[emoji].length === 0) {
            delete reactions[emoji];
          }
        } else {
          // Add reaction
          reactions[emoji] = [...usersReacted, uid];
        }

        transaction.update(msgRef, { reactions });
      });
    }

    // Send message
    sendMessageBtn.onclick = async () => {
      const text = messageInput.value.trim();
      if (!text || !currentGroupId) return;
      await db
        .collection("groups")
        .doc(currentGroupId)
        .collection("messages")
        .add({
          uid: auth.currentUser.uid,
          text,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          reactions: {},
        });
      messageInput.value = "";
    };
  </script>
</body>
</html>
