<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Firebase Chat Groups & Direct Messaging</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-900 text-white">
  <div id="app" class="flex h-screen">
    
    <!-- Sidebar for Groups & Direct Messages -->
    <aside class="w-1/5 bg-gray-800 p-4 flex flex-col space-y-4 overflow-y-auto">
      <h1 class="text-xl font-bold">Direct Messages</h1>

      <!-- Direct Messages List -->
      <div id="dmList" class="flex flex-col gap-2 max-h-40 overflow-y-auto"></div>

      <!-- New DM Form -->
      <form id="create-dm-form" class="flex gap-2 mb-6">
        <input id="dm-email" type="email" placeholder="User Email for DM" class="flex-1 p-2 bg-gray-700 rounded" required />
        <button type="submit" class="bg-green-600 px-2 rounded">âž•</button>
      </form>

      <h1 class="text-xl font-bold">Groups</h1>
      
      <!-- Group List -->
      <div id="groupList" class="flex flex-col gap-2 overflow-y-auto flex-1"></div>
      
      <!-- Create Group -->
      <form id="create-group-form" class="flex gap-2">
        <input id="group-name" type="text" placeholder="New Group" class="flex-1 p-2 bg-gray-700 rounded" required />
        <button type="submit" class="bg-green-600 px-2 rounded">âž•</button>
      </form>
      
      <button id="logout" class="bg-red-600 p-2 rounded">Logout</button>
    </aside>
    
    <!-- Chat Area -->
    <main class="flex-1 flex flex-col">
      <header class="p-4 border-b border-gray-700 flex justify-between items-center">
        <h2 id="chatTitle" class="text-xl font-semibold">Select a Group or Direct Message</h2>
        <button id="backToGroups" class="hidden bg-gray-600 px-3 py-1 rounded">Back to Groups</button>
      </header>
      <div id="chatMessages" class="flex-1 p-4 overflow-y-auto space-y-2"></div>
      <footer class="p-4 border-t border-gray-700 flex items-center gap-2">
        <input id="messageInput" type="text" placeholder="Type a message..." class="flex-1 p-2 bg-gray-800 rounded" />
        <button id="sendMessage" class="bg-blue-600 p-2 rounded">Send</button>
      </footer>
    </main>
  </div>

  <!-- Login Screen -->
  <div id="loginScreen" class="fixed inset-0 flex justify-center items-center bg-gray-900 z-50">
    <div class="bg-gray-800 p-6 rounded w-80">
      <h2 class="text-xl mb-4">Login</h2>
      <input id="email" type="email" placeholder="Email" class="w-full p-2 mb-2 bg-gray-700 rounded" />
      <input id="password" type="password" placeholder="Password" class="w-full p-2 mb-2 bg-gray-700 rounded" />
      <button id="login" class="w-full bg-blue-600 p-2 rounded">Login</button>
      <button id="signup" class="w-full mt-2 bg-green-600 p-2 rounded">Sign Up</button>
    </div>
  </div>

  <script>
    // ðŸ”§ Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyDuGHDotdc-EZRxyyJLrWXyLsi2dLhSHm4",
      authDomain: "chatting-fd641.firebaseapp.com",
      projectId: "chatting-fd641",
      storageBucket: "chatting-fd641.appspot.com",
      messagingSenderId: "535384451291",
      appId: "1:535384451291:web:828f60686d81be018b44fe"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // DOM refs
    const loginScreen = document.getElementById('loginScreen');
    const app = document.getElementById('app');
    const loginBtn = document.getElementById('login');
    const signupBtn = document.getElementById('signup');
    const logoutBtn = document.getElementById('logout');
    const groupList = document.getElementById('groupList');
    const createGroupForm = document.getElementById('create-group-form');
    const groupNameInput = document.getElementById('group-name');
    const chatMessages = document.getElementById('chatMessages');
    const messageInput = document.getElementById('messageInput');
    const sendMessageBtn = document.getElementById('sendMessage');
    const chatTitle = document.getElementById('chatTitle');

    const dmList = document.getElementById('dmList');
    const createDmForm = document.getElementById('create-dm-form');
    const dmEmailInput = document.getElementById('dm-email');
    const backToGroupsBtn = document.getElementById('backToGroups');

    let currentGroupId = null;
    let currentDmId = null;
    let currentUser = null;

    // Auth listener
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        loginScreen.style.display = 'none';
        app.style.display = 'flex';
        loadGroups();
        loadDirectMessages();
        showGroupsSidebar();
        resetChatArea();
      } else {
        loginScreen.style.display = 'flex';
        app.style.display = 'none';
        currentUser = null;
      }
    });

    // Auth actions
    loginBtn.onclick = () => {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      auth.signInWithEmailAndPassword(email, password).catch(e => alert(e.message));
    };

    signupBtn.onclick = () => {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      auth.createUserWithEmailAndPassword(email, password).catch(e => alert(e.message));
    };

    logoutBtn.onclick = () => auth.signOut();

    // Create group
    createGroupForm.onsubmit = async (e) => {
      e.preventDefault();
      const name = groupNameInput.value.trim();
      if (!name) return;

      await db.collection('groups').add({
        name,
        members: [currentUser.uid],
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      groupNameInput.value = '';
    };

    // Load groups
    function loadGroups() {
      db.collection('groups').orderBy('createdAt')
        .onSnapshot(snapshot => {
          groupList.innerHTML = '';
          snapshot.forEach(doc => {
            const group = doc.data();
            const div = document.createElement('div');
            div.textContent = group.name;
            div.className = 'cursor-pointer bg-gray-700 rounded-full px-3 py-2 text-center hover:bg-gray-600';
            div.onclick = () => {
              currentDmId = null;
              selectGroup(doc.id, group.name);
              showGroupsSidebar();
            };
            groupList.appendChild(div);
          });
        });
    }

    // Select group
    let groupUnsubscribe = null;
    function selectGroup(id, name) {
      currentGroupId = id;
      chatTitle.textContent = name;
      messageInput.disabled = false;
      sendMessageBtn.disabled = false;
      backToGroupsBtn.classList.add('hidden');

      if (groupUnsubscribe) groupUnsubscribe(); // unsubscribe from previous listener

      groupUnsubscribe = db.collection('groups').doc(id).collection('messages').orderBy('createdAt')
        .onSnapshot(snapshot => {
          chatMessages.innerHTML = '';
          snapshot.forEach(doc => {
            const data = doc.data();
            const div = document.createElement('div');
            div.className = 'bg-gray-800 p-2 rounded';
            div.textContent = `${data.text}`;
            if(data.uid === currentUser.uid) div.classList.add('text-blue-400');
            chatMessages.appendChild(div);
          });
          chatMessages.scrollTop = chatMessages.scrollHeight;
        });
    }

    // Reset chat area when no group or DM is selected
    function resetChatArea() {
      currentGroupId = null;
      currentDmId = null;
      chatMessages.innerHTML = '';
      chatTitle.textContent = 'Select a Group or Direct Message';
      messageInput.value = '';
      messageInput.disabled = true;
      sendMessageBtn.disabled = true;
      backToGroupsBtn.classList.add('hidden');
    }

    // Send message for group or DM
    sendMessageBtn.onclick = async () => {
      const text = messageInput.value.trim();
      if (!text) return;

      if (currentGroupId) {
        await db.collection('groups').doc(currentGroupId).collection('messages').add({
          uid: currentUser.uid,
          text,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      } else if (currentDmId) {
        await db.collection('private_chats').doc(currentDmId).collection('messages').add({
          uid: currentUser.uid,
          text,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
      messageInput.value = '';
    };

    // ----------- Direct Messaging Section -----------

    // Load direct messages for current user
    function loadDirectMessages() {
      db.collection('private_chats')
        .where('participants', 'array-contains', currentUser.uid)
        .orderBy('lastUpdated', 'desc')
        .onSnapshot(snapshot => {
          dmList.innerHTML = '';
          snapshot.forEach(doc => {
            const chat = doc.data();
            const otherUserId = chat.participants.find(uid => uid !== currentUser.uid);
            // Get other user's email from users collection (or fallback)
            getUserEmail(otherUserId).then(email => {
              const div = document.createElement('div');
              div.textContent = email || 'Unknown User';
              div.className = 'cursor-pointer bg-gray-700 rounded-full px-3 py-2 text-center hover:bg-gray-600';
              div.onclick = () => {
                currentGroupId = null;
                selectDirectMessage(doc.id, email);
                showDirectMessagesSidebar();
              };
              dmList.appendChild(div);
            });
          });
        });
    }

    // Helper to get user email by uid
    async function getUserEmail(uid) {
      try {
        const userDoc = await db.collection('users').doc(uid).get();
        if (userDoc.exists) return userDoc.data().email;
        else return null;
      } catch {
        return null;
      }
    }

    // Select a direct message chat
    let dmUnsubscribe = null;
    function selectDirectMessage(dmId, otherUserEmail) {
      currentDmId = dmId;
      chatTitle.textContent = `DM with ${otherUserEmail}`;
      messageInput.disabled = false;
      sendMessageBtn.disabled = false;
      backToGroupsBtn.classList.remove('hidden');

      if (dmUnsubscribe) dmUnsubscribe();

      dmUnsubscribe = db.collection('private_chats').doc(dmId).collection('messages').orderBy('createdAt')
        .onSnapshot(snapshot => {
          chatMessages.innerHTML = '';
          snapshot.forEach(doc => {
            const data = doc.data();
            const div = document.createElement('div');
            div.className = 'bg-gray-800 p-2 rounded';
            div.textContent = `${data.text}`;
            if(data.uid === currentUser.uid) div.classList.add('text-green-400');
            chatMessages.appendChild(div);
          });
          chatMessages.scrollTop = chatMessages.scrollHeight;
        });
    }

    // Back to groups button click
    backToGroupsBtn.onclick = () => {
      resetChatArea();
      showGroupsSidebar();
    };

    // Create new DM
    createDmForm.onsubmit = async (e) => {
      e.preventDefault();
      const email = dmEmailInput.value.trim();
      if (!email || email === currentUser.email) {
        alert("Enter a valid different user's email.");
        return;
      }
      // Find user by email
      const userQuery = await db.collection('users').where('email', '==', email).get();
      if (userQuery.empty) {
        alert("User not found.");
        return;
      }
      const otherUser = userQuery.docs[0];
      const otherUserId = otherUser.id;

      // Check if DM already exists between users
      const existingDMQuery = await db.collection('private_chats')
        .where('participants', 'array-contains', currentUser.uid)
        .get();

      let dmId = null;
      existingDMQuery.forEach(doc => {
        const chat = doc.data();
        if (chat.participants.includes(otherUserId) && chat.participants.length === 2) {
          dmId = doc.id;
        }
      });

      if (!dmId) {
        // Create new DM
        const dmDoc = await db.collection('private_chats').add({
          participants: [currentUser.uid, otherUserId],
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        });
        dmId = dmDoc.id;
      }

      dmEmailInput.value = '';
      selectDirectMessage(dmId, email);
      showDirectMessagesSidebar();
    };

    // Show groups sidebar and hide direct messages (optional UI control)
    function showGroupsSidebar() {
      groupList.parentElement.style.display = 'block';
      dmList.parentElement.style.display = 'block';
      backToGroupsBtn.classList.add('hidden');
    }

    function showDirectMessagesSidebar() {
      // You can customize UI to highlight DM section or hide groups
      backToGroupsBtn.classList.remove('hidden');
    }

    // On user signup, save their email and uid to users collection
    auth.onAuthStateChanged(user => {
      if (user) {
        db.collection('users').doc(user.uid).set({
          email: user.email,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
      }
    });
  </script>
</body>
</html>
