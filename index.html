<!DOCTYPE html>
<html lang="en" class="dark">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WhatsApp Style Chat</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Emoji Button -->
<script src="https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@4.6.2/dist/index.min.js"></script>

<style>
  body {
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: #ece5dd;
    height: 100vh;
    margin: 0;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .app-container {
    width: 100vw;
    height: 100vh;
    max-width: 1100px;
    max-height: 700px;
    background: white;
    display: flex;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border-radius: 8px;
    overflow: hidden;
  }
  #groupsPage {
    width: 320px;
    background: #ffffff;
    border-right: 1px solid #ddd;
    display: flex;
    flex-direction: column;
  }
  #groupsPage header {
    font-weight: 600;
    font-size: 1.2rem;
    padding: 15px 20px;
    border-bottom: 1px solid #ddd;
    background: #f6f6f6;
  }
  #groupsList {
    flex-grow: 1;
    overflow-y: auto;
    padding: 10px 15px;
  }
  #groupsList div {
    padding: 12px 15px;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: background-color 0.15s ease;
  }
  #groupsList div:hover {
    background: #f2f2f2;
  }
  #groupsList div.selected {
    background: #dcf8c6;
  }
  #groupsList button {
    background: transparent;
    border: none;
    font-size: 1rem;
    cursor: pointer;
  }
  #newGroupForm {
    padding: 10px 15px;
    border-top: 1px solid #ddd;
    display: flex;
  }
  #newGroupName {
    flex-grow: 1;
    padding: 8px 12px;
    border-radius: 20px;
    border: 1px solid #ccc;
    outline: none;
  }
  #newGroupName:focus {
    border-color: #25d366;
  }
  #createGroupBtn {
    margin-left: 8px;
    background: #25d366;
    border: none;
    color: white;
    padding: 8px 15px;
    border-radius: 20px;
    cursor: pointer;
    font-weight: 600;
  }
  #chatPage {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    background: #ece5dd;
  }
  #chatHeader {
    background: #075e54;
    color: white;
    padding: 15px 20px;
    font-weight: 600;
    font-size: 1.1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  #chatHeader button {
    background: transparent;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
  }
  #messages {
    flex-grow: 1;
    padding: 20px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
  }
  .message {
    max-width: 60%;
    margin-bottom: 12px;
    padding: 10px 15px;
    border-radius: 7.5px;
    font-size: 0.9rem;
    line-height: 1.3;
    position: relative;
    word-wrap: break-word;
    box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
  }
  .message.sent {
    background-color: #dcf8c6;
    align-self: flex-end;
    border-bottom-right-radius: 0;
  }
  .message.sent .username {
    display: none;
  }
  .message.received {
    background-color: white;
    align-self: flex-start;
    border-bottom-left-radius: 0;
  }
  .message .username {
    font-weight: 600;
    font-size: 0.75rem;
    color: #444;
    margin-bottom: 3px;
  }
  .message img {
    max-width: 200px;
    border-radius: 10px;
    margin-top: 5px;
  }
  #messageForm {
    background: white;
    padding: 12px 20px;
    display: flex;
    align-items: center;
    border-top: 1px solid #ddd;
  }
  #messageInput {
    flex-grow: 1;
    padding: 10px 15px;
    border-radius: 25px;
    border: 1px solid #ddd;
    outline: none;
    font-size: 1rem;
  }
  #messageInput:focus {
    border-color: #25d366;
  }
  #emojiBtn, #imageInputLabel {
    cursor: pointer;
    margin-left: 10px;
    font-size: 1.5rem;
    color: #888;
    user-select: none;
  }
  #sendBtn {
    background: #25d366;
    border: none;
    color: white;
    padding: 10px 18px;
    border-radius: 25px;
    margin-left: 10px;
    cursor: pointer;
    font-weight: 600;
  }
  #sendBtn:disabled {
    background: #a5d6a7;
    cursor: not-allowed;
  }
  #login-section {
    display: flex;
    height: 100vh;
    justify-content: center;
    align-items: center;
    flex-direction: column;
  }
  #login-section input {
    padding: 12px 15px;
    font-size: 1rem;
    border-radius: 25px;
    border: 1px solid #ddd;
    outline: none;
    margin-bottom: 15px;
    width: 250px;
  }
  #login-section button {
    background: #25d366;
    border: none;
    color: white;
    padding: 12px 30px;
    font-size: 1rem;
    border-radius: 25px;
    cursor: pointer;
    font-weight: 600;
  }
</style>
</head>
<body>

<div id="login-section">
  <input id="username-input" type="text" placeholder="Enter your name" />
  <button id="login-btn">Login</button>
</div>

<div class="app-container" id="chat-ui" style="display:none;">

  <!-- Groups Sidebar -->
  <div id="groupsPage">
    <header>Groups</header>
    <div id="groupsList">Loading groups...</div>
    <form id="newGroupForm" onsubmit="event.preventDefault(); createGroup();">
      <input id="newGroupName" type="text" placeholder="New group name" autocomplete="off" />
      <button id="createGroupBtn" type="submit">Create</button>
    </form>
  </div>

  <!-- Chat Window -->
  <div id="chatPage" class="hidden flex flex-col">
    <div id="chatHeader">
      <button onclick="backToGroups()">‚Üê</button>
      <div id="groupTitle">Select a group</div>
      <div id="currentUserLabel" title="You"></div>
    </div>

    <div id="messages"></div>

    <form id="messageForm" onsubmit="event.preventDefault(); sendMessage();">
      <input
        id="messageInput"
        type="text"
        placeholder="Type a message"
        autocomplete="off"
      />
      <label id="emojiBtn" title="Insert emoji" style="user-select:none;">üòä</label>
      <label id="imageInputLabel" title="Attach image" for="imageInput" style="user-select:none;">üìé</label>
      <input type="file" id="imageInput" accept="image/*" style="display:none" />
      <button id="sendBtn" type="submit" disabled>Send</button>
    </form>
  </div>

</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    onSnapshot,
    query,
    orderBy,
    doc,
    getDocs,
    deleteDoc,
    serverTimestamp,
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import {
    getStorage,
    ref as storageRef,
    uploadBytesResumable,
    getDownloadURL,
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

  // Firebase config - REPLACE with your own Firebase config!
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID",
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // DOM Elements
  const loginSection = document.getElementById("login-section");
  const usernameInput = document.getElementById("username-input");
  const loginBtn = document.getElementById("login-btn");
  const chatUI = document.getElementById("chat-ui");

  const groupsList = document.getElementById("groupsList");
  const newGroupForm = document.getElementById("newGroupForm");
  const newGroupName = document.getElementById("newGroupName");

  const chatPage = document.getElementById("chatPage");
  const groupTitle = document.getElementById("groupTitle");
  const messages = document.getElementById("messages");
  const messageForm = document.getElementById("messageForm");
  const messageInput = document.getElementById("messageInput");
  const sendBtn = document.getElementById("sendBtn");
  const emojiBtn = document.getElementById("emojiBtn");
  const imageInput = document.getElementById("imageInput");
  const imageInputLabel = document.getElementById("imageInputLabel");
  const currentUserLabel = document.getElementById("currentUserLabel");

  let currentUser = "";
  let currentGroupId = null;
  let emojiPicker = null;

  // Enable or disable send button based on input
  function updateSendButton() {
    sendBtn.disabled = !messageInput.value.trim() && !imageInput.files.length;
  }

  messageInput.addEventListener("input", updateSendButton);
  imageInput.addEventListener("change", updateSendButton);

  // Login flow
  loginBtn.addEventListener("click", () => {
    const username = usernameInput.value.trim();
    if (username.length < 1) {
      alert("Please enter your name.");
      return;
    }
    currentUser = username;
    loginSection.style.display = "none";
    chatUI.style.display = "flex";
    currentUserLabel.textContent = currentUser;
    loadGroups();
  });

  // Load groups and listen for changes
  async function loadGroups() {
    groupsList.innerHTML = "Loading groups...";
    const groupsQuery = query(collection(db, "groups"), orderBy("createdAt", "asc"));

    onSnapshot(groupsQuery, (snapshot) => {
      groupsList.innerHTML = "";
      if (snapshot.empty) {
        groupsList.innerHTML = "<p class='text-gray-500'>No groups available. Create one!</p>";
        return;
      }
      snapshot.forEach((docSnap) => {
        const group = docSnap.data();
        const groupId = docSnap.id;

        const groupDiv = document.createElement("div");
        groupDiv.textContent = group.name;
        groupDiv.classList.add("group-item");
        if (groupId === currentGroupId) groupDiv.classList.add("selected");
        groupDiv.onclick = () => selectGroup(groupId, group.name);

        // Delete button
        const delBtn = document.createElement("button");
        delBtn.textContent = "√ó";
        delBtn.title = "Delete group";
        delBtn.onclick = async (e) => {
          e.stopPropagation();
          if (confirm(`Delete group "${group.name}"? This cannot be undone.`)) {
            await deleteGroup(groupId);
          }
        };
        groupDiv.appendChild(delBtn);

        groupsList.appendChild(groupDiv);
      });
    });
  }

  // Create a new group
  async function createGroup() {
    const name = newGroupName.value.trim();
    if (!name) return alert("Group name cannot be empty.");
    try {
      await addDoc(collection(db, "groups"), {
        name,
        createdAt: serverTimestamp(),
      });
      newGroupName.value = "";
    } catch (error) {
      console.error("Error creating group:", error);
      alert("Failed to create group.");
    }
  }

  // Delete a group and its messages
  async function deleteGroup(groupId) {
    try {
      // Delete group doc
      await deleteDoc(doc(db, "groups", groupId));

      // Delete messages inside group
      const messagesSnapshot = await getDocs(collection(db, "groups", groupId, "messages"));
      const batchDeletes = messagesSnapshot.docs.map((msg) => deleteDoc(msg.ref));
      await Promise.all(batchDeletes);

      if (currentGroupId === groupId) {
        currentGroupId = null;
        groupTitle.textContent = "Select a group";
        messages.innerHTML = "";
        chatPage.classList.add("hidden");
      }
    } catch (error) {
      console.error("Error deleting group:", error);
      alert("Failed to delete group.");
    }
  }

  // Select group and load messages
  function selectGroup(groupId, groupName) {
    currentGroupId = groupId;
    groupTitle.textContent = groupName;

    // Highlight selected group
    document.querySelectorAll("#groupsList div").forEach((div) => {
      div.classList.toggle("selected", div.textContent === groupName);
    });

    chatPage.classList.remove("hidden");
    messages.innerHTML = "";

    loadMessages(groupId);
  }

  // Load and listen for messages in a group
  function loadMessages(groupId) {
    // Clear previous listeners if any
    if (window.unsubscribeMessages) window.unsubscribeMessages();

    const messagesQuery = query(
      collection(db, "groups", groupId, "messages"),
      orderBy("timestamp", "asc")
    );

    window.unsubscribeMessages = onSnapshot(messagesQuery, (snapshot) => {
      messages.innerHTML = "";
      snapshot.forEach((docSnap) => {
        const msg = docSnap.data();
        displayMessage(msg);
      });
      messages.scrollTop = messages.scrollHeight;
    });
  }

  // Display a single message
  function displayMessage(msg) {
    const messageDiv = document.createElement("div");
    messageDiv.classList.add("message");
    messageDiv.classList.add(msg.sender === currentUser ? "sent" : "received");

    if (msg.sender !== currentUser) {
      const usernameDiv = document.createElement("div");
      usernameDiv.classList.add("username");
      usernameDiv.textContent = msg.sender;
      messageDiv.appendChild(usernameDiv);
    }

    if (msg.text) {
      const textDiv = document.createElement("div");
      textDiv.textContent = msg.text;
      messageDiv.appendChild(textDiv);
    }

    if (msg.imageUrl) {
      const img = document.createElement("img");
      img.src = msg.imageUrl;
      img.alt = "Image";
      messageDiv.appendChild(img);
    }

    messages.appendChild(messageDiv);
  }

  // Send message
  async function sendMessage() {
    if (!currentGroupId) return alert("Select a group first.");
    if (!messageInput.value.trim() && !imageInput.files.length) return;

    sendBtn.disabled = true;

    let imageUrl = null;
    if (imageInput.files.length > 0) {
      try {
        imageUrl = await uploadImage(imageInput.files[0]);
      } catch (err) {
        alert("Image upload failed");
        sendBtn.disabled = false;
        return;
      }
    }

    try {
      await addDoc(collection(db, "groups", currentGroupId, "messages"), {
        sender: currentUser,
        text: messageInput.value.trim() || "",
        imageUrl: imageUrl || null,
        timestamp: serverTimestamp(),
      });
      messageInput.value = "";
      imageInput.value = "";
      updateSendButton();
    } catch (error) {
      console.error("Error sending message:", error);
      alert("Failed to send message.");
    }
    sendBtn.disabled = false;
  }

  // Upload image to Firebase Storage
  function uploadImage(file) {
    return new Promise((resolve, reject) => {
      const ext = file.name.split(".").pop();
      const fileName = `images/${Date.now()}-${Math.random().toString(36).substr(2, 9)}.${ext}`;
      const fileRef = storageRef(storage, fileName);
      const uploadTask = uploadBytesResumable(fileRef, file);

      uploadTask.on(
        "state_changed",
        null,
        (error) => {
          console.error("Upload failed", error);
          reject(error);
        },
        () => {
          getDownloadURL(uploadTask.snapshot.ref).then((downloadURL) => {
            resolve(downloadURL);
          });
        }
      );
    });
  }

  // Emoji picker setup
  emojiPicker = new EmojiButton({
    position: "top-end",
    theme: "auto",
  });

  emojiBtn.addEventListener("click", () => {
    emojiPicker.togglePicker(emojiBtn);
  });

  emojiPicker.on("emoji", (emoji) => {
    const cursorPos = messageInput.selectionStart;
    const textBefore = messageInput.value.substring(0, cursorPos);
    const textAfter = messageInput.value.substring(cursorPos);
    messageInput.value = textBefore + emoji + textAfter;
    messageInput.focus();
    messageInput.selectionStart = cursorPos + emoji.length;
    messageInput.selectionEnd = cursorPos + emoji.length;
    updateSendButton();
  });

  // Back button to groups list
  function backToGroups() {
    chatPage.classList.add("hidden");
    currentGroupId = null;
    groupTitle.textContent = "Select a group";
    messages.innerHTML = "";
  }

  // Expose functions globally
  window.createGroup = createGroup;
  window.backToGroups = backToGroups;

</script>
</body>
</html>
