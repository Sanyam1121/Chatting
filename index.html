<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat App - WhatsApp Style</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@4.6.2/dist/index.min.js"></script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import {
        getFirestore,
        collection,
        addDoc,
        onSnapshot,
        query,
        orderBy,
        doc,
        getDocs,
        deleteDoc,
        serverTimestamp,
        updateDoc
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
      import {
        getStorage,
        ref,
        uploadBytes,
        getDownloadURL
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDuGHDotdc-EZRxyyJLrWXyLsi2dLhSHm4",
        authDomain: "chatting-fd641.firebaseapp.com",
        projectId: "chatting-fd641",
        storageBucket: "chatting-fd641.appspot.com",
        messagingSenderId: "535384451291",
        appId: "1:535384451291:web:828f60686d81be018b44fe",
        measurementId: "G-RKS4CFZPJ4"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const storage = getStorage(app);

      let currentUser = null;
      let selectedImage = null;
      let currentGroupId = null;

      window.onload = () => {
        const loginBtn = document.getElementById("login-btn");
        loginBtn.addEventListener("click", login);

        const picker = new EmojiButton();
        const trigger = document.querySelector("#emojiBtn");
        picker.on("emoji", emoji => {
          document.getElementById("messageInput").value += emoji;
        });
        trigger.addEventListener("click", () => picker.togglePicker(trigger));
      };

      function login() {
        const name = document.getElementById("username-input").value.trim();
        if (!name) return alert("Please enter your name");

        currentUser = {
          uid: "user-" + Math.random().toString(36).substring(2, 10),
          displayName: name
        };
        document.getElementById("login-section").style.display = "none";
        document.getElementById("chat-ui").style.display = "flex";
        document.getElementById("currentUserLabel").textContent = `Logged in as: ${currentUser.displayName}`;
        loadGroups();
      }

      function loadGroups() {
        const groupsList = document.getElementById("groupsList");
        groupsList.innerHTML = "Loading groups...";
        const groupsRef = collection(db, "groups");
        onSnapshot(groupsRef, snapshot => {
          groupsList.innerHTML = "";
          if (snapshot.empty) {
            groupsList.innerHTML = "<p class='text-gray-500'>No groups yet. Create one!</p>";
            return;
          }
          snapshot.forEach(docSnap => {
            const group = docSnap.data();
            const container = document.createElement("div");
            container.className = "p-3 border rounded mb-2 flex justify-between items-center hover:bg-blue-100 dark:hover:bg-gray-700";

            const nameDiv = document.createElement("div");
            nameDiv.textContent = group.name;
            nameDiv.className = "cursor-pointer flex-1";
            nameDiv.onclick = () => enterGroup(docSnap.id, group.name);

            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "‚ùå";
            deleteBtn.className = "ml-2 text-red-600 hover:text-red-800 text-sm";
            deleteBtn.onclick = e => {
              e.stopPropagation();
              if (confirm(`Delete group \"${group.name}\"?`)) {
                deleteGroup(docSnap.id);
              }
            };

            container.appendChild(nameDiv);
            container.appendChild(deleteBtn);
            groupsList.appendChild(container);
          });
        });
      }

      async function deleteGroup(groupId) {
        const messagesRef = collection(db, "groups", groupId, "messages");
        const messagesSnap = await getDocs(messagesRef);
        const deletePromises = messagesSnap.docs.map(doc => deleteDoc(doc.ref));
        await Promise.all(deletePromises);
        await deleteDoc(doc(db, "groups", groupId));
        alert("Group deleted successfully.");
      }

      window.createGroup = async () => {
        const groupNameInput = document.getElementById("newGroupName");
        const name = groupNameInput.value.trim();
        if (!name) return alert("Enter a group name");
        await addDoc(collection(db, "groups"), {
          name,
          createdAt: serverTimestamp()
        });
        groupNameInput.value = "";
      };

      function enterGroup(groupId, groupName) {
        currentGroupId = groupId;
        document.getElementById("groupTitle").textContent = groupName;
        document.getElementById("groupsPage").classList.add("hidden");
        document.getElementById("chatPage").classList.remove("hidden");
        listenToMessages(groupId);
      }

      window.backToGroups = () => {
        currentGroupId = null;
        document.getElementById("chatPage").classList.add("hidden");
        document.getElementById("groupsPage").classList.remove("hidden");
      };

      window.sendMessage = async () => {
        if (!currentGroupId) return alert("No group selected");
        const text = document.getElementById("messageInput").value.trim();
        if (!text && !selectedImage) return;
        let imageUrl = null;
        if (selectedImage) {
          const storageRef = ref(storage, "images/" + Date.now() + "-" + selectedImage.name);
          await uploadBytes(storageRef, selectedImage);
          imageUrl = await getDownloadURL(storageRef);
          selectedImage = null;
        }
        await addDoc(collection(db, "groups", currentGroupId, "messages"), {
          uid: currentUser.uid,
          username: currentUser.displayName,
          text: text || null,
          imageUrl: imageUrl || null,
          timestamp: serverTimestamp(),
          readBy: [currentUser.uid]
        });
        document.getElementById("messageInput").value = "";
        document.getElementById("imageInput").value = "";
      };

      function listenToMessages(groupId) {
        const messagesRef = collection(db, "groups", groupId, "messages");
        const q = query(messagesRef, orderBy("timestamp", "asc"));
        onSnapshot(q, snapshot => {
          const messagesList = document.getElementById("messages");
          messagesList.innerHTML = "";
          snapshot.forEach(async docSnap => {
            const msg = docSnap.data();
            const div = document.createElement("div");
            div.className =
              "p-2 rounded-lg max-w-[70%] mb-2 flex flex-col " +
              (msg.uid === currentUser.uid ? "bg-green-500 text-white self-end" : "bg-gray-300 text-black self-start");
            div.innerHTML =
              `<div class='text-xs mb-1 opacity-70'>${msg.username}${msg.readBy?.length > 1 ? ' ‚úÖ' : ''}</div>` +
              (msg.text ? `<div>${msg.text}</div>` : "") +
              (msg.imageUrl ? `<img src='${msg.imageUrl}' class='mt-2 rounded shadow max-w-[200px]'/>` : "");

            if (!msg.readBy?.includes(currentUser.uid)) {
              await updateDoc(doc(messagesRef, docSnap.id), {
                readBy: [...(msg.readBy || []), currentUser.uid]
              });
            }

            messagesList.appendChild(div);
          });
          messagesList.scrollTop = messagesList.scrollHeight;
        });
      }

      window.previewImage = event => {
        selectedImage = event.target.files[0];
      };
    </script>
  </head>
  <body class="min-h-screen bg-gray-100 dark:bg-gray-900 text-black dark:text-white flex flex-col items-center p-4">
    <div class="text-center text-lg text-red-500 mb-4 font-bold">
      üõ†Ô∏è The system is currently in developer mode. Some features might be experimental.
    </div>
    <!-- UI Code Remains Unchanged -->
  </body>
</html>
